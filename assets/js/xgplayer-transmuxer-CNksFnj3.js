
/**
 * 由 MrZhang 提供技术支持
 * Powered by elegant-admin
 * Github https://github.com/zhangyao1990/elegant-admin
 */

function Xe(n,a){var e=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(e!=null){var t,r,i,s,o=[],u=!0,l=!1;try{if(i=(e=e.call(n)).next,a!==0)for(;!(u=(t=i.call(e)).done)&&(o.push(t.value),o.length!==a);u=!0);}catch(f){l=!0,r=f}finally{try{if(!u&&e.return!=null&&(s=e.return(),Object(s)!==s))return}finally{if(l)throw r}}return o}}function I(n,a){if(!(n instanceof a))throw new TypeError("Cannot call a class as a function")}function Ie(n,a){for(var e=0;e<a.length;e++){var t=a[e];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,Ge(t.key),t)}}function T(n,a,e){return a&&Ie(n.prototype,a),e&&Ie(n,e),Object.defineProperty(n,"prototype",{writable:!1}),n}function c(n,a,e){return a=Ge(a),a in n?Object.defineProperty(n,a,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[a]=e,n}function Ye(n,a){if(typeof a!="function"&&a!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(a&&a.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),Object.defineProperty(n,"prototype",{writable:!1}),a&&Ee(n,a)}function J(n){return J=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},J(n)}function Ee(n,a){return Ee=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},Ee(n,a)}function Qe(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Je(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function $e(n,a){if(a&&(typeof a=="object"||typeof a=="function"))return a;if(a!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Je(n)}function et(n){var a=Qe();return function(){var t=J(n),r;if(a){var i=J(this).constructor;r=Reflect.construct(t,arguments,i)}else r=t.apply(this,arguments);return $e(this,r)}}function tt(n,a){return nt(n)||Xe(n,a)||Fe(n,a)||at()}function F(n){return rt(n)||it(n)||Fe(n)||st()}function rt(n){if(Array.isArray(n))return Se(n)}function nt(n){if(Array.isArray(n))return n}function it(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function Fe(n,a){if(n){if(typeof n=="string")return Se(n,a);var e=Object.prototype.toString.call(n).slice(8,-1);if(e==="Object"&&n.constructor&&(e=n.constructor.name),e==="Map"||e==="Set")return Array.from(n);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Se(n,a)}}function Se(n,a){(a==null||a>n.length)&&(a=n.length);for(var e=0,t=new Array(a);e<a;e++)t[e]=n[e];return t}function st(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function at(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function ot(n,a){if(typeof n!="object"||n===null)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var t=e.call(n,a||"default");if(typeof t!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(n)}function Ge(n){var a=ot(n,"string");return typeof a=="symbol"?a:String(a)}var Q={VIDEO:"video",AUDIO:"audio",METADATA:"metadata"},X={AVC:"avc",HEVC:"hevc"},$={AAC:"aac",G711PCMA:"g7110a",G711PCMU:"g7110m"},Y={LARGE_AV_SHIFT:"LARGE_AV_SHIFT",LARGE_VIDEO_GAP:"LARGE_VIDEO_GAP",LARGE_VIDEO_GAP_BETWEEN_CHUNK:"LARGE_VIDEO_GAP_BETWEEN_CHUNK",LARGE_AUDIO_GAP:"LARGE_AUDIO_GAP",AUDIO_FILLED:"AUDIO_FILLED",AUDIO_DROPPED:"AUDIO_DROPPED"},Ne=function(){function n(){I(this,n),c(this,"id",1),c(this,"type",Q.VIDEO),c(this,"codecType",X.AVC),c(this,"pid",-1),c(this,"hvcC",void 0),c(this,"codec",""),c(this,"timescale",0),c(this,"formatTimescale",0),c(this,"sequenceNumber",0),c(this,"baseMediaDecodeTime",0),c(this,"baseDts",0),c(this,"duration",0),c(this,"warnings",[]),c(this,"samples",[]),c(this,"pps",[]),c(this,"sps",[]),c(this,"vps",[]),c(this,"fpsNum",0),c(this,"fpsDen",0),c(this,"sarRatio",[]),c(this,"width",0),c(this,"height",0),c(this,"nalUnitSize",4),c(this,"present",!1),c(this,"isVideoEncryption",!1),c(this,"isAudioEncryption",!1),c(this,"isVideo",!0),c(this,"kid",null),c(this,"pssh",null),c(this,"ext",void 0)}return T(n,[{key:"reset",value:function(){this.sequenceNumber=this.width=this.height=this.fpsDen=this.fpsNum=this.duration=this.baseMediaDecodeTime=this.timescale=0,this.codec="",this.present=!1,this.pid=-1,this.pps=[],this.sps=[],this.vps=[],this.sarRatio=[],this.samples=[],this.warnings=[],this.hvcC=null}},{key:"firstDts",get:function(){return this.samples.length?this.samples[0].dts:null}},{key:"firstPts",get:function(){return this.samples.length?this.samples[0].pts:null}},{key:"samplesDuration",get:function(){if(this.samples.length>0){var e=this.samples[0],t=this.samples[this.samples.length-1];return t.dts-e.dts+t.duration}return 0}},{key:"exist",value:function(){return!!(this.pps.length&&this.sps.length&&this.codec)}},{key:"hasSample",value:function(){return!!this.samples.length}},{key:"isEncryption",get:function(){return this.isVideoEncryption}}]),n}(),He=function(){function n(){I(this,n),c(this,"id",2),c(this,"type",Q.AUDIO),c(this,"codecType",$.AAC),c(this,"pid",-1),c(this,"codec",""),c(this,"sequenceNumber",0),c(this,"sampleDuration",0),c(this,"timescale",0),c(this,"formatTimescale",0),c(this,"baseMediaDecodeTime",0),c(this,"duration",0),c(this,"warnings",[]),c(this,"samples",[]),c(this,"baseDts",0),c(this,"sampleSize",16),c(this,"sampleRate",0),c(this,"channelCount",0),c(this,"objectType",0),c(this,"sampleRateIndex",0),c(this,"config",[]),c(this,"present",!1),c(this,"isVideoEncryption",!1),c(this,"isAudioEncryption",!1),c(this,"kid",null),c(this,"ext",void 0)}return T(n,[{key:"reset",value:function(){this.sequenceNumber=0,this.timescale=0,this.sampleDuration=0,this.sampleRate=0,this.channelCount=0,this.baseMediaDecodeTime=0,this.present=!1,this.pid=-1,this.codec="",this.samples=[],this.config=[],this.warnings=[]}},{key:"exist",value:function(){return!!(this.sampleRate&&this.channelCount&&this.codec&&this.codecType===$.AAC)}},{key:"hasSample",value:function(){return!!this.samples.length}},{key:"isEncryption",get:function(){return this.isAudioEncryption}},{key:"firstDts",get:function(){return this.samples.length?this.samples[0].dts:null}},{key:"firstPts",get:function(){return this.samples.length?this.samples[0].pts:null}},{key:"samplesDuration",get:function(){if(this.samples.length>0){var e=this.samples[0],t=this.samples[this.samples.length-1];return t.dts-e.dts+t.duration}return 0}}]),n}(),We=function(){function n(a,e,t){I(this,n),c(this,"flag",{}),c(this,"keyframe",!1),c(this,"gopId",0),c(this,"duration",0),c(this,"size",0),c(this,"units",[]),c(this,"chromaFormat",420),this.originPts=this.pts=a,this.originDts=this.dts=e,t&&(this.units=t)}return T(n,[{key:"cts",get:function(){return this.pts-this.dts}},{key:"setToKeyframe",value:function(){this.keyframe=!0,this.flag.dependsOn=2,this.flag.isNonSyncSample=0}}]),n}(),ee=T(function n(a,e,t,r){I(this,n),c(this,"duration",1024),c(this,"flag",{dependsOn:2,isNonSyncSample:0}),c(this,"keyframe",!0),this.originPts=this.pts=this.dts=a,this.data=e,this.size=e.byteLength,this.sampleOffset=r,t&&(this.duration=t)}),ut=T(function n(a,e){I(this,n),c(this,"time",0),this.data=a,this.originPts=this.pts=e}),lt=function(n){Ye(e,n);var a=et(e);function e(){return I(this,e),a.apply(this,arguments)}return T(e)}(ut),Ke=function(){function n(){I(this,n),c(this,"id",3),c(this,"type",Q.METADATA),c(this,"timescale",0),c(this,"flvScriptSamples",[]),c(this,"seiSamples",[])}return T(n,[{key:"exist",value:function(){return!!((this.flvScriptSamples.length||this.seiSamples.length)&&this.timescale)}},{key:"reset",value:function(){this.timescale=0,this.flvScriptSamples=[],this.seiSamples=[]}},{key:"hasSample",value:function(){return!!(this.flvScriptSamples.length||this.seiSamples.length)}}]),n}(),je=function(){function n(a){I(this,n),this.name=a||"",this._prefix="[".concat(this.name,"]")}return T(n,[{key:"warn",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).warn.apply(e,[this._prefix].concat(r))}}}],[{key:"enable",value:function(){n.disabled=!1}},{key:"disable",value:function(){n.disabled=!0}}]),n}();c(je,"disabled",!0);var te=typeof window<"u",Be=te&&navigator.userAgent.toLocaleLowerCase(),ft=te&&/^((?!chrome|android).)*safari/.test(Be),vt=te&&Be.includes("firefox"),ct=te&&Be.includes("android"),H=function(){function n(){I(this,n)}return T(n,null,[{key:"getRateIndexByRate",value:function(e){return n.FREQ.indexOf(e)}},{key:"parseADTS",value:function(e,t){for(var r=e.length,i=0;i+2<r&&!(e[i]===255&&(e[i+1]&246)===240);)i++;if(!(i>=r)){var s=i,o=[],u=(e[i+2]&60)>>>2,l=n.FREQ[u];if(!l)throw new Error("Invalid sampling index: ".concat(u));for(var f=((e[i+2]&192)>>>6)+1,d=(e[i+2]&1)<<2|(e[i+3]&192)>>>6,v=n._getConfig(u,d,f),p=v.config,y=v.codec,w,h,g=0,k=n.getFrameDuration(l);i+7<r;){if(e[i]!==255||(e[i+1]&246)!==240){i++;continue}if(h=(e[i+3]&3)<<11|e[i+4]<<3|(e[i+5]&224)>>5,r-i<h)break;w=(~e[i+1]&1)*2,o.push({pts:t+g*k,data:e.subarray(i+7+w,i+h)}),g++,i+=h}return{skip:s,remaining:i>=r?void 0:e.subarray(i),frames:o,samplingFrequencyIndex:u,sampleRate:l,objectType:f,channelCount:d,codec:y,config:p,originCodec:"mp4a.40.".concat(f)}}}},{key:"parseAudioSpecificConfig",value:function(e){if(e.length){var t=e[0]>>>3,r=(e[0]&7)<<1|e[1]>>>7,i=(e[1]&120)>>>3,s=n.FREQ[r];if(s){var o=n._getConfig(r,i,t),u=o.config,l=o.codec;return{samplingFrequencyIndex:r,sampleRate:s,objectType:t,channelCount:i,config:u,codec:l,originCodec:"mp4a.40.".concat(t)}}}}},{key:"getFrameDuration",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9e4;return 1024*t/e}},{key:"_getConfig",value:function(e,t,r){var i=[],s,o;return vt?e>=6?(s=5,o=e-3):(s=2,o=e):ct?(s=2,o=e):(s=r===2||r===5?r:5,o=e,e>=6?o=e-3:t===1&&(s=2,o=e)),i[0]=s<<3,i[0]|=(e&14)>>1,i[1]=(e&1)<<7,i[1]|=t<<3,s===5&&(i[1]|=(o&14)>>1,i[2]=(o&1)<<7,i[2]|=8,i[3]=0),{config:i,codec:"mp4a.40.".concat(s)}}},{key:"getSilentFrame",value:function(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}]),n}();c(H,"FREQ",[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]);function G(){for(var n=arguments.length,a=new Array(n),e=0;e<n;e++)a[e]=arguments[e];a=a.filter(Boolean);var t=new Uint8Array(a.reduce(function(i,s){return i+s.byteLength},0)),r=0;return a.forEach(function(i){t.set(i,r),r+=i.byteLength}),t}var ht=Math.pow(2,32);function C(n){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(n[a]<<8)+(n[a+1]||0)}function pt(n){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(n[a]<<16)+(n[a+1]<<8)+(n[a+2]||0)}function m(n){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(n[a]<<24>>>0)+(n[a+1]<<16)+(n[a+2]<<8)+(n[a+3]||0)}function W(n){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return m(n,a)*ht+m(n,a+4)}function qe(n){for(var a="avc1.",e,t=0;t<3;t++)e=n[t].toString(16),e.length<2&&(e="0".concat(e)),a+=e;return a}function Te(n){if(!Array.isArray(n)){for(var a=[],e="",t=0;t<n.length;t++)t%2&&(e=n[t-1]+n[t],a.push(parseInt(e,16)),e="");return a}return n.map(function(r){return parseInt(r,16)})}var K=function(){function n(){I(this,n)}return T(n,null,[{key:"parseAnnexB",value:function(e){for(var t=e.length,r=2,i=0;e[r]!==null&&e[r]!==void 0&&e[r]!==1;)r++;if(r++,i=r+2,i>=t)return[];for(var s=[];i<t;)switch(e[i]){case 0:if(e[i-1]!==0){i+=2;break}else if(e[i-2]!==0){i++;break}r!==i-2&&s.push(e.subarray(r,i-2));do i++;while(e[i]!==1&&i<t);r=i+1,i=r+2;break;case 1:if(e[i-1]!==0||e[i-2]!==0){i+=3;break}r!==i-2&&s.push(e.subarray(r,i-2)),r=i+1,i=r+2;break;default:i+=3;break}return r<t&&s.push(e.subarray(r)),s}},{key:"parseAvcC",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4;if(!(e.length<4)){for(var r=e.length,i=[],s=0,o;s+t<r;)if(o=m(e,s),t===3&&(o>>>=8),s+=t,!!o){if(s+o>r)break;i.push(e.subarray(s,s+o)),s+=o}return i}}},{key:"parseSEI",value:function(e,t){for(var r=e.length,i=t?2:1,s=0,o=0,u="";e[i]===255;)s+=255,i++;for(s+=e[i++];e[i]===255;)o+=255,i++;if(o+=e[i++],s===5&&r>i+16)for(var l=0;l<16;l++)u+=e[i].toString(16),i++;return{payload:e.subarray(i,i+o),type:s,size:o,uuid:u}}},{key:"removeEPB",value:function(e){for(var t=e.byteLength,r=[],i=1;i<t-2;)e[i]===0&&e[i+1]===0&&e[i+2]===3?(r.push(i+2),i+=2):i++;if(!r.length)return e;var s=t-r.length,o=new Uint8Array(s),u=0;for(i=0;i<s;u++,i++)u===r[0]&&(u++,r.shift()),o[i]=e[u];return o}}]),n}(),ke=function(){function n(a){if(I(this,n),c(this,"_bytesAvailable",void 0),c(this,"_bitsAvailable",0),c(this,"_word",0),!a)throw new Error("ExpGolomb data params is required");this._data=a,this._bytesAvailable=a.byteLength,this._bytesAvailable&&this._loadWord()}return T(n,[{key:"bitsAvailable",get:function(){return this._bitsAvailable}},{key:"_loadWord",value:function(){var e=this._data.byteLength-this._bytesAvailable,t=Math.min(4,this._bytesAvailable);if(t===0)throw new Error("No bytes available");var r=new Uint8Array(4);r.set(this._data.subarray(e,e+t)),this._word=new DataView(r.buffer).getUint32(0),this._bitsAvailable=t*8,this._bytesAvailable-=t}},{key:"skipBits",value:function(e){if(this._bitsAvailable>e)this._word<<=e,this._bitsAvailable-=e;else{e-=this._bitsAvailable;var t=Math.floor(e/8);e-=t*8,this._bytesAvailable-=t,this._loadWord(),this._word<<=e,this._bitsAvailable-=e}}},{key:"readBits",value:function(e){if(e>32)throw new Error("Cannot read more than 32 bits");var t=Math.min(this._bitsAvailable,e),r=this._word>>>32-t;return this._bitsAvailable-=t,this._bitsAvailable>0?this._word<<=t:this._bytesAvailable>0&&this._loadWord(),t=e-t,t>0&&this._bitsAvailable?r<<t|this.readBits(t):r}},{key:"skipLZ",value:function(){var e;for(e=0;e<this._bitsAvailable;++e)if(this._word&2147483648>>>e)return this._word<<=e,this._bitsAvailable-=e,e;return this._loadWord(),e+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var e=this.skipLZ();return this.readBits(e+1)-1}},{key:"readEG",value:function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}},{key:"readBool",value:function(){return this.readBits(1)===1}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"skipScalingList",value:function(e){for(var t=8,r=8,i,s=0;s<e;s++)r!==0&&(i=this.readEG(),r=(t+i+256)%256),t=r===0?t:r}}]),n}(),dt=function(){function n(){I(this,n)}return T(n,null,[{key:"parseAVCDecoderConfigurationRecord",value:function(e){if(!(e.length<7)){for(var t=(e[4]&3)+1,r,i=[],s=[],o=6,u=e[5]&31,l,f=0;f<u;f++)if(l=e[o]<<8|e[o+1],o+=2,!!l){var d=e.subarray(o,o+l);o+=l,i.push(d),r||(r=n.parseSPS(K.removeEPB(d)))}var v=e[o];o++;for(var p,y=0;y<v;y++)p=e[o]<<8|e[o+1],o+=2,p&&(s.push(e.subarray(o,o+p)),o+=p);return{sps:r,spsArr:i,ppsArr:s,nalUnitSize:t}}}},{key:"parseSPS",value:function(e){var t=new ke(e);t.readUByte();var r=t.readUByte(),i=t.readUByte(),s=t.readUByte();t.skipUEG();var o=420;if(r===100||r===110||r===122||r===244||r===44||r===83||r===86||r===118||r===128||r===138||r===144){var u=t.readUEG();if(u<=3&&(o=[0,420,422,444][u]),u===3&&t.skipBits(1),t.skipUEG(),t.skipUEG(),t.skipBits(1),t.readBool())for(var l=u!==3?8:12,f=0;f<l;f++)t.readBool()&&(f<6?t.skipScalingList(16):t.skipScalingList(64))}t.skipUEG();var d=t.readUEG();if(d===0)t.readUEG();else if(d===1){t.skipBits(1),t.skipUEG(),t.skipUEG();for(var v=t.readUEG(),p=0;p<v;p++)t.skipUEG()}t.skipUEG(),t.skipBits(1);var y=t.readUEG(),w=t.readUEG(),h=t.readBits(1);h===0&&t.skipBits(1),t.skipBits(1);var g=0,k=0,b=0,S=0;t.readBool()&&(g=t.readUEG(),k=t.readUEG(),b=t.readUEG(),S=t.readUEG());var A,P,B,U,V;if(t.readBool()){if(t.readBool()){var M=t.readUByte();switch(M){case 1:A=[1,1];break;case 2:A=[12,11];break;case 3:A=[10,11];break;case 4:A=[16,11];break;case 5:A=[40,33];break;case 6:A=[24,11];break;case 7:A=[20,11];break;case 8:A=[32,11];break;case 9:A=[80,33];break;case 10:A=[18,11];break;case 11:A=[15,11];break;case 12:A=[64,33];break;case 13:A=[160,99];break;case 14:A=[4,3];break;case 15:A=[3,2];break;case 16:A=[2,1];break;case 255:{A=[t.readUByte()<<8|t.readUByte(),t.readUByte()<<8|t.readUByte()];break}}}if(t.readBool()&&t.readBool(),t.readBool()&&(t.readBits(4),t.readBool()&&t.readBits(24)),t.readBool()&&(t.readUEG(),t.readUEG()),t.readBool()){var R=t.readBits(32),O=t.readBits(32);P=t.readBool(),B=O,U=R*2,V=B/U}}return{codec:qe(e.subarray(1,4)),profileIdc:r,profileCompatibility:i,levelIdc:s,chromaFormat:o,width:Math.ceil((y+1)*16-2*(g+k)),height:(2-h)*(w+1)*16-(h?2:4)*(b+S),sarRatio:A,fpsNum:B,fpsDen:U,fps:V,fixedFrame:P}}}]),n}(),Ve=function(){function n(){I(this,n)}return T(n,null,[{key:"parseHEVCDecoderConfigurationRecord",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!(e.length<23)){t=t||{};for(var r=(e[21]&3)+1,i,s,o=[],u=[],l=[],f=23,d=e[22],v,p,y,w=0;w<d;w++){v=e[f]&63,p=e[f+1]<<8|e[f+2],f+=3;for(var h=0;h<p;h++)if(y=e[f]<<8|e[f+1],f+=2,!!y){switch(v){case 32:{var g=e.subarray(f,f+y);i||(i=n.parseVPS(K.removeEPB(g),t)),l.push(g)}break;case 33:{var k=e.subarray(f,f+y);s||(s=n.parseSPS(K.removeEPB(k),t)),o.push(k)}break;case 34:u.push(e.subarray(f,f+y));break}f+=y}}return{hvcC:t,sps:s,spsArr:o,ppsArr:u,vpsArr:l,nalUnitSize:r}}}},{key:"parseVPS",value:function(e,t){t=t||{};var r=new ke(e);r.readUByte(),r.readUByte(),r.readBits(12);var i=r.readBits(3);return t.numTemporalLayers=Math.max(t.numTemporalLayers||0,i+1),r.readBits(17),n._parseProfileTierLevel(r,i,t),t}},{key:"parseSPS",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};t=t||{};var r=new ke(e);r.readUByte(),r.readUByte(),r.readBits(4);var i=r.readBits(3);t.numTemporalLayers=Math.max(i+1,t.numTemporalLayers||0),t.temporalIdNested=r.readBits(1),n._parseProfileTierLevel(r,i,t),r.readUEG();var s=t.chromaFormatIdc=r.readUEG(),o=420;s<=3&&(o=[0,420,422,444][s]);var u=0;s===3&&(u=r.readBits(1));var l=r.readUEG(),f=r.readUEG(),d=r.readBits(1),v,p,y,w;if(d===1&&(v=r.readUEG(),p=r.readUEG(),y=r.readUEG(),w=r.readUEG()),t.bitDepthLumaMinus8=r.readUEG(),t.bitDepthChromaMinus8=r.readUEG(),d===1){var h=(s===1||s===2)&&u===0?2:1,g=s===1&&u===0?2:1;l-=h*(p+v),f-=g*(w+y)}return{codec:"hev1.1.6.L93.B0",width:l,height:f,chromaFormat:o,hvcC:t}}},{key:"_parseProfileTierLevel",value:function(e,t,r){var i=r.generalTierFlag||0;r.generalProfileSpace=e.readBits(2),r.generalTierFlag=Math.max(e.readBits(1),i),r.generalProfileIdc=Math.max(e.readBits(5),r.generalProfileIdc||0),r.generalProfileCompatibilityFlags=e.readBits(32),r.generalConstraintIndicatorFlags=[e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8)];var s=e.readBits(8);i<r.generalTierFlag?r.generalLevelIdc=s:r.generalLevelIdc=Math.max(s,r.generalLevelIdc||0);var o=[],u=[];if(t>e.bitsAvailable)throw new Error("maxSubLayersMinus inavlid size ".concat(t));for(var l=0;l<t;l++)o[l]=e.readBits(1),u[l]=e.readBits(1);t>0&&e.readBits((8-t)*2);for(var f=0;f<t;f++)o[f]!==0&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),u[f]!==0&&e.readBits(8)}}]),n}(),mt=9e4/2,Me=3,Ae=9e4,we=5*9e4,xe=9e4,yt=9e4/2,gt=function(){function n(a,e,t){I(this,n),this.videoTrack=a,this.audioTrack=e,this.metadataTrack=t,this._baseDts=-1,this._baseDtsInited=!1,this._audioNextPts=void 0,this._videoNextDts=void 0,this._audioTimestampBreak=!1,this._videoTimestampBreak=!1,this._lastAudioExceptionGapDot=0,this._lastAudioExceptionOverlapDot=0,this._lastAudioExceptionLargeGapDot=0}return T(n,[{key:"fix",value:function(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;t=Math.round(t*9e4);var s=this.videoTrack,o=this.audioTrack,u=s.samples,l=o.samples;if(!(!u.length&&!l.length)){var f=u[0],d=l[0],v=0;if(u.length&&l.length&&(v=f.dts-d.pts),this._baseDtsInited||this._calculateBaseDts(this.audioTrack,this.videoTrack),r&&(this._calculateBaseDts(this.audioTrack,this.videoTrack),this._baseDts-=t),!i){this._videoNextDts=v>0?t+v:t,this._audioNextPts=v>0?t:t-v;var p=f?f.dts-this._baseDts-this._videoNextDts:0,y=d?d.pts-this._baseDts-this._audioNextPts:0;Math.abs(p||y)>xe&&(this._calculateBaseDts(this.audioTrack,this.videoTrack),this._baseDts-=t)}if(this._resetBaseDtsWhenStreamBreaked(),this._fixAudio(o),this._fixVideo(s),this.metadataTrack.exist()){var w=this.metadataTrack.timescale;this.metadataTrack.seiSamples.forEach(function(h){h.pts=h.originPts-e._baseDts,h.time=Math.max(0,h.pts)/w})}s.samples.length&&(s.baseMediaDecodeTime=s.samples[0].dts),o.samples.length&&(o.baseMediaDecodeTime=o.samples[0].pts*o.timescale/9e4)}}},{key:"_fixVideo",value:function(e){var t=this,r=e.samples;if(r.length){if(r.forEach(function(B){B.dts-=t._baseDts,B.pts-=t._baseDts}),this._videoNextDts===void 0){var i=r[0];this._videoNextDts=i.dts}var s=r.length,o=0,u=r[0],l=r[1],f=this._videoNextDts-u.dts;if(Math.abs(f)>yt){var d;if(e.warnings.push({type:Y.LARGE_VIDEO_GAP_BETWEEN_CHUNK,nextDts:this._videoNextDts/90,firstSampleDts:u.dts/90,nextSampleDts:(((d=r[1])===null||d===void 0?void 0:d.dts)||0)/90,sampleDuration:f/90}),u.dts+=f,u.pts+=f,l&&Math.abs(l.dts-u.dts)>xe)this._videoTimestampBreak=!0,r.forEach(function(B,U){U!==0&&(B.dts+=f,B.pts+=f)});else for(var v=1;v<s-1;v++){var p,y=(p=r[v])===null||p===void 0?void 0:p.dts,w=r[v-1].dts;y&&y-w<0&&(r[v].dts+=f,r[v].pts+=f)}}var h;if(e.fpsNum&&e.fpsDen&&(h=e.timescale*(e.fpsDen/e.fpsNum)),h<90*10&&(h=0),!h){var g=e.samples[0],k=e.samples[1];h=s===1?9e3:Math.floor(k.dts-g.dts)}for(var b=0;b<s;b++){var S=r[b].dts,A=r[b+1];if(b<s-1?o=A.dts-S:r[b-1]?o=Math.min(S-r[b-1].dts,h):o=h,o>xe||o<0){this._videoTimestampBreak=!0,o=this._audioTimestampBreak?h:Math.max(o,30*90);var P=this._audioNextPts||0;A&&A.dts>P&&(o=h),e.warnings.push({type:Y.LARGE_VIDEO_GAP,time:S/e.timescale,dts:S,originDts:r[b].originDts,nextDts:this._videoNextDts,sampleDuration:o,refSampleDuration:h})}r[b].duration=o,this._videoNextDts+=o}}}},{key:"_fixAudio",value:function(e){var t=this,r=e.samples;r.length&&(r.forEach(function(i){i.pts-=t._baseDts,i.dts=i.pts}),this._doFixAudioInternal(e,r,9e4))}},{key:"_calculateBaseDts",value:function(e,t){var r=e.samples,i=t.samples;if(!r.length&&!i.length)return!1;var s=1/0,o=1/0;r.length&&(e.baseDts=s=r[0].pts),i.length&&(t.baseDts=o=i[0].dts),this._baseDts=Math.min(s,o);var u=o-s;return Number.isFinite(u)&&Math.abs(u)>mt&&t.warnings.push({type:Y.LARGE_AV_SHIFT,videoBaseDts:o,audioBasePts:s,baseDts:this._baseDts,delta:u}),this._baseDtsInited=!0,!0}},{key:"_resetBaseDtsWhenStreamBreaked",value:function(){if(this._baseDtsInited&&this._videoTimestampBreak&&this._audioTimestampBreak){var e=this._calculateBaseDts(this.audioTrack,this.videoTrack);if(!e)return;this._baseDts-=Math.min(this._audioNextPts,this._videoNextDts),this._audioLastSample=null,this._videoLastSample=null,this._videoTimestampBreak=!1,this._audioTimestampBreak=!1}}},{key:"_doFixAudioInternal",value:function(e,t,r){e.sampleDuration||(e.sampleDuration=H.getFrameDuration(e.timescale,r));var i=e.sampleDuration;if(this._audioNextPts===void 0){var s=t[0];this._audioNextPts=s.pts}for(var o=0;o<t.length;o++){var u=this._audioNextPts,l=t[o],f=l.pts-u;if(!this._audioTimestampBreak&&f>=Me*i&&f<=Ae&&!ft){var d=H.getSilentFrame(e.codec,e.channelCount)||t[0].data.subarray(),v=Math.floor(f/i);Math.abs(l.pts-this._lastAudioExceptionGapDot)>we&&(this._lastAudioExceptionGapDot=l.pts),e.warnings.push({type:Y.AUDIO_FILLED,pts:l.pts/90,originPts:l.originPts,count:v,nextPts:u/90,refSampleDuration:i});for(var p=0;p<v;p++){var y=new ee(Math.floor(u),d);y.originPts=Math.floor(this._baseDts+u),t.splice(o,0,y),this._audioNextPts+=i,o++}o--}else f<=-Me*i&&f>=-1*Ae?(Math.abs(l.pts-this._lastAudioExceptionOverlapDot)>we&&(this._lastAudioExceptionOverlapDot=l.pts,e.warnings.push({type:Y.AUDIO_DROPPED,pts:l.pts/90,originPts:l.originPts,nextPts:u/90,refSampleDuration:i})),t.splice(o,1),o--):(Math.abs(f)>=Ae&&(this._audioTimestampBreak=!0,Math.abs(l.pts-this._lastAudioExceptionLargeGapDot)>we&&(this._lastAudioExceptionLargeGapDot=l.pts,e.warnings.push({type:Y.LARGE_AUDIO_GAP,time:l.pts/1e3,pts:l.pts/90,originPts:l.originPts,nextPts:u/90,sampleDuration:f,refSampleDuration:i}))),l.dts=l.pts=u,this._audioNextPts+=i)}}}]),n}(),N=new je("TsDemuxer"),wt=function(){function n(a,e,t){I(this,n),c(this,"_pmtId",-1),c(this,"_remainingPacketData",null),c(this,"_videoPesData",[]),c(this,"_audioPesData",[]),c(this,"_gopId",0),this.videoTrack=a||new Ne,this.audioTrack=e||new He,this.metadataTrack=t||new Ke,this._fixer=new gt(this.videoTrack,this.audioTrack,this.metadataTrack)}return T(n,[{key:"demux",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=this.audioTrack,s=this.videoTrack,o=this.metadataTrack;t&&(this._pmtId=-1,s.reset(),i.reset(),o.reset()),!r||t?(this._remainingPacketData=null,this._videoPesData=[],this._audioPesData=[]):(s.samples=[],i.samples=[],o.seiSamples=[],s.warnings=[],i.warnings=[],this._remainingPacketData&&(e=G(this._remainingPacketData,e),this._remainingPacketData=null));var u=e.length,l=u%188;l&&(this._remainingPacketData=e.subarray(u-l),u-=l);for(var f=s.pid,d=i.pid,v=0;v<u;v+=188){if(e[v]!==71)throw new Error("TS packet did not start with 0x47");var p=!!(e[v+1]&64),y=((e[v+1]&31)<<8)+e[v+2],w=(e[v+3]&48)>>4,h=void 0;if(w>1){if(h=v+5+e[v+4],h===v+188)continue}else h=v+4;switch(y){case 0:p&&(h+=e[h]+1),this._pmtId=(e[h+10]&31)<<8|e[h+11];break;case this._pmtId:{p&&(h+=e[h]+1);var g=h+3+((e[h+1]&15)<<8|e[h+2])-4,k=(e[h+10]&15)<<8|e[h+11];for(h+=12+k;h<g;){var b=(e[h+1]&31)<<8|e[h+2];switch(e[h]){case 15:i.pid=d=b;break;case 27:if(f!==-1)break;s.codecType=X.AVC,s.pid=f=b;break;case 36:if(f!==-1)break;s.codecType=X.HEVC,s.pid=f=b;break;default:N.warn("Unsupported stream. type: ".concat(e[h],", pid: ").concat(b))}h+=((e[h+3]&15)<<8|e[h+4])+5}}break;case f:p&&this._videoPesData.length&&this._parseVideoData(),this._videoPesData.push(e.subarray(h,v+188));break;case d:p&&this._audioPesData.length&&this._parseAudioData(),this._audioPesData.push(e.subarray(h,v+188));break;case 17:case 8191:break;default:N.warn("Unknown pid: ".concat(y))}}return this._parseVideoData(),this._parseAudioData(),i.formatTimescale=s.formatTimescale=s.timescale=o.timescale=9e4,i.timescale=i.sampleRate||0,{videoTrack:s,audioTrack:i,metadataTrack:o}}},{key:"fix",value:function(e,t,r){return this._fixer.fix(e,t,r),{videoTrack:this.videoTrack,audioTrack:this.audioTrack,metadataTrack:this.metadataTrack}}},{key:"demuxAndFix",value:function(e,t,r,i){return this.demux(e,t,r),this.fix(i,t,r)}},{key:"_parseVideoData",value:function(){if(this._videoPesData.length){var e=n._parsePES(G.apply(void 0,F(this._videoPesData)));if(!e){N.warn("Cannot parse video pes",this._videoPesData);return}var t=K.parseAnnexB(e.data);t?this._createVideoSample(t,e.pts,e.dts):N.warn("Cannot parse avc units",e),this._videoPesData=[]}}},{key:"_createVideoSample",value:function(e,t,r){var i=this;if(e.length){var s=this.videoTrack,o=s.codecType===X.HEVC,u=new We(t,r);e.forEach(function(l){var f=o?l[0]>>>1&63:l[0]&31;switch(f){case 5:case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:if(!o&&f!==5||o&&f===5)break;u.setToKeyframe(),i._gopId++;break;case 6:case 39:case 40:if(!o&&f!==6||o&&f===6)break;i.metadataTrack.seiSamples.push(new lt(K.parseSEI(K.removeEPB(l),o),t));return;case 32:if(!o)break;if(!s.vps.length){var d=Ve.parseVPS(K.removeEPB(l),s.hvcC);s.hvcC=s.hvcC||d,s.vps=[l]}break;case 7:case 33:if(!o&&f!==7||o&&f===7)break;if(!s.sps.length){var v=K.removeEPB(l),p=o?Ve.parseSPS(v,s.hvcC):dt.parseSPS(v);s.sps=[l],s.hvcC=s.hvcC||p.hvcC,s.codec=p.codec,s.width=p.width,s.height=p.height,s.sarRatio=p.sarRatio,s.fpsNum=p.fpsNum,s.fpsDen=p.fpsDen}break;case 8:case 34:if(!o&&f!==8||o&&f===8)break;s.pps.length||(s.pps=[l]);break;case 9:case 35:break;case 38:if(o){for(var y=!1,w=2;w<l.byteLength;w++)if(l[w]===255){y=!0;break}if(!y)return}break}u.units.push(l)}),u.gopId=this._gopId,this._pushVideoSample(s,u)}}},{key:"_pushVideoSample",value:function(e,t){if(t.units.length)if(t.pts===null||t.pts===void 0){N.warn("Video sample no pts",t);var r=e.samples[e.samples.length-1];r?(t.pts=r.pts,t.dts=r.dts):N.warn("Drop video sample",t)}else e.samples.push(t)}},{key:"_parseAudioData",value:function(){if(this._audioPesData.length){var e=n._parsePES(G.apply(void 0,F(this._audioPesData)));if(!e){N.warn("Cannot parse audio pes",this._audioPesData);return}this._parseAacData(e),this._audioPesData=[]}}},{key:"_parseAacData",value:function(e){var t=this.audioTrack,r=e.pts;if(r==null){if(N.warn("AAC pes not pts",t),!t.samples.length||!t.sampleRate)return;r=t.samples[t.samples.length-1].pts+H.getFrameDuration(t.sampleRate)}var i=H.parseADTS(e.data,r);if(i){var s;t.codec=i.codec,t.channelCount=i.channelCount,t.sampleRate=i.sampleRate,t.objectType=i.objectType,t.sampleRateIndex=i.samplingFrequencyIndex,t.config=i.config,(s=t.samples).push.apply(s,F(i.frames.map(function(o){return new ee(o.pts,o.data)}))),i.skip&&N.warn("Skip aac adts ".concat(i.skip," bits")),i.remaining&&N.warn("Remaining aac adts ".concat(i.remaining," bits"))}else N.warn("Cannot parse aac adts",e)}}],[{key:"probe",value:function(e){return e.length?e[0]===71&&e[188]===71&&e[376]===71:!1}},{key:"_parsePES",value:function(e){var t=e[8];if(!(t==null||e.length<t+9)){var r=e[0]<<16|e[1]<<8|e[2];if(r===1){var i=(e[4]<<8)+e[5];if(!(i&&i>e.length-6)){var s,o,u=e[7];return u&192&&(s=(e[9]&14)*536870912+(e[10]&255)*4194304+(e[11]&254)*16384+(e[12]&255)*128+(e[13]&254)/2,u&64?(o=(e[14]&14)*536870912+(e[15]&255)*4194304+(e[16]&254)*16384+(e[17]&255)*128+(e[18]&254)/2,s-o>60*9e4&&(s=o)):o=s),{data:e.subarray(9+t),pts:s,dts:o}}}}}}]),n}(),z=function(){function n(){I(this,n)}return T(n,null,[{key:"findBox",value:function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=[];if(!e)return i;for(var s=0,o="",u=0;e.length>7;){if(s=m(e),o=String.fromCharCode.apply(null,e.subarray(4,8)),u=8,s===1?(s=W(e,8),u+=8):s||(s=e.length),!t[0]||o===t[0]){var l=e.subarray(0,s);if(t.length<2)i.push({start:r,size:s,headerSize:u,type:o,data:l});else return n.findBox(l.subarray(u),t.slice(1),r+u)}r+=s,e=e.subarray(s)}return i}},{key:"tfhd",value:function(e){return D(e,!0,function(t,r){t.trackId=m(r);var i=4,s=t.flags&255&1,o=t.flags&255&2,u=t.flags&255&8,l=t.flags&255&16,f=t.flags&255&32;s&&(i+=4,t.baseDataOffset=m(r,i),i+=4),o&&(t.sampleDescriptionIndex=m(r,i),i+=4),u&&(t.defaultSampleDuration=m(r,i),i+=4),l&&(t.defaultSampleSize=m(r,i),i+=4),f&&(t.defaultSampleFlags=m(r,i))})}},{key:"sidx",value:function(e){return D(e,!0,function(t,r){var i=0;t.reference_ID=m(r,i),i+=4,t.timescale=m(r,i),i+=4,t.version===0?(t.earliest_presentation_time=m(r,i),i+=4,t.first_offset=m(r,i),i+=4):(t.earliest_presentation_time=W(r,i),i+=8,t.first_offset=W(r,i),i+=8),i+=2,t.references=[];var s=C(r,i);i+=2;for(var o=0;o<s;o++){var u={};t.references.push(u);var l=m(r,i);i+=4,u.reference_type=l>>31&1,u.referenced_size=l&2147483647,u.subsegment_duration=m(r,i),i+=4,l=m(r,i),i+=4,u.starts_with_SAP=l>>31&1,u.SAP_type=l>>28&7,u.SAP_delta_time=l&268435455}})}},{key:"moov",value:function(e){return D(e,!1,function(t,r,i){t.mvhd=n.mvhd(n.findBox(r,["mvhd"],i)[0]),t.trak=n.findBox(r,["trak"],i).map(function(s){return n.trak(s)}),t.pssh=n.pssh(n.findBox(r,["pssh"],i)[0])})}},{key:"mvhd",value:function(e){return D(e,!0,function(t,r){var i=0;t.version===1?(t.timescale=m(r,16),t.duration=W(r,20),i+=28):(t.timescale=m(r,8),t.duration=m(r,12),i+=16),t.nextTrackId=m(r,i+76)})}},{key:"trak",value:function(e){return D(e,!1,function(t,r,i){t.tkhd=n.tkhd(n.findBox(r,["tkhd"],i)[0]),t.mdia=n.mdia(n.findBox(r,["mdia"],i)[0])})}},{key:"tkhd",value:function(e){return D(e,!0,function(t,r){var i=0;t.version===1?(t.trackId=m(r,16),t.duration=W(r,24),i+=32):(t.trackId=m(r,8),t.duration=m(r,16),i+=20),t.width=m(r,i+52),t.height=m(r,i+56)})}},{key:"mdia",value:function(e){return D(e,!1,function(t,r,i){t.mdhd=n.mdhd(n.findBox(r,["mdhd"],i)[0]),t.hdlr=n.hdlr(n.findBox(r,["hdlr"],i)[0]),t.minf=n.minf(n.findBox(r,["minf"],i)[0])})}},{key:"mdhd",value:function(e){return D(e,!0,function(t,r){var i=0;t.version===1?(t.timescale=m(r,16),t.duration=W(r,20),i+=28):(t.timescale=m(r,8),t.duration=m(r,12),i+=16);var s=C(r,i);t.language=String.fromCharCode((s>>10&31)+96,(s>>5&31)+96,(s&31)+96)})}},{key:"hdlr",value:function(e){return D(e,!0,function(t,r){t.version===0&&(t.handlerType=String.fromCharCode.apply(null,r.subarray(4,8)))})}},{key:"minf",value:function(e){return D(e,!1,function(t,r,i){t.vmhd=n.vmhd(n.findBox(r,["vmhd"],i)[0]),t.smhd=n.smhd(n.findBox(r,["smhd"],i)[0]),t.stbl=n.stbl(n.findBox(r,["stbl"],i)[0])})}},{key:"vmhd",value:function(e){return D(e,!0,function(t,r){t.graphicsmode=C(r),t.opcolor=[C(r,2),C(r,4),C(r,6)]})}},{key:"smhd",value:function(e){return D(e,!0,function(t,r){t.balance=C(r)})}},{key:"stbl",value:function(e){return D(e,!1,function(t,r,i){var s,o,u;t.stsd=n.stsd(n.findBox(r,["stsd"],i)[0]),t.stts=n.stts(n.findBox(r,["stts"],i)[0]),t.ctts=n.ctts(n.findBox(r,["ctts"],i)[0]),t.stsc=n.stsc(n.findBox(r,["stsc"],i)[0]),t.stsz=n.stsz(n.findBox(r,["stsz"],i)[0]),t.stco=n.stco(n.findBox(r,["stco"],i)[0]),t.stco||(t.co64=n.co64(n.findBox(r,["co64"],i)[0]),t.stco=t.co64);var l=(s=t.stsd.entries[0])===null||s===void 0||(o=s.sinf)===null||o===void 0||(u=o.schi)===null||u===void 0?void 0:u.tenc.default_IV_size;t.stss=n.stss(n.findBox(r,["stss"],i)[0]),t.senc=n.senc(n.findBox(r,["senc"],i)[0],l)})}},{key:"senc",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8;return D(e,!0,function(r,i){var s=0,o=m(i,s);s+=4,r.samples=[];for(var u=0;u<o;u++){var l={};l.InitializationVector=[];for(var f=0;f<t;f++)l.InitializationVector[f]=i[s+f];if(s+=t,r.flags&2){l.subsamples=[];var d=C(i,s);s+=2;for(var v=0;v<d;v++){var p={};p.BytesOfClearData=C(i,s),s+=2,p.BytesOfProtectedData=m(i,s),s+=4,l.subsamples.push(p)}}r.samples.push(l)}})}},{key:"pssh",value:function(e){return D(e,!0,function(t,r){for(var i=[],s=[],o=0,u=0;u<16;u++)s.push(De(r[o+u]));if(o+=16,t.version>0){var l=m(r,o);o+=4;for(var f=0;f<(""+l).length;f++)for(var d=0;d<16;d++){var v=r[o];o+=1,i.push(De(v))}}var p=m(r,o);t.data_size=p,o+=4,t.kid=i,t.system_id=s,t.buffer=r})}},{key:"stsd",value:function(e){return D(e,!0,function(t,r,i){t.entryCount=m(r),t.entries=n.findBox(r.subarray(4),[],i+4).map(function(s){switch(s.type){case"avc1":case"avc2":case"avc3":case"avc4":return n.avc1(s);case"hvc1":case"hev1":return n.hvc1(s);case"mp4a":return n.mp4a(s);case"alaw":case"ulaw":return n.alaw(s);case"enca":return D(s,!1,function(o,u,l){o.channelCount=C(u,16),o.samplesize=C(u,18),o.sampleRate=m(u,24)/65536,u=u.subarray(28),o.sinf=n.sinf(n.findBox(u,["sinf"],l)[0]),o.esds=n.esds(n.findBox(u,["esds"],l)[0])});case"encv":return D(s,!1,function(o,u,l){o.width=C(u,24),o.height=C(u,26),o.horizresolution=m(u,28),o.vertresolution=m(u,32),u=u.subarray(78),o.sinf=n.sinf(n.findBox(u,["sinf"],l)[0]),o.avcC=n.avcC(n.findBox(u,["avcC"],l)[0]),o.hvcC=n.hvcC(n.findBox(u,["hvcC"],l)[0]),o.pasp=n.pasp(n.findBox(u,["pasp"],l)[0])})}}).filter(Boolean)})}},{key:"tenc",value:function(e){return D(e,!1,function(t,r){var i=6;t.default_IsEncrypted=r[i],i+=1,t.default_IV_size=r[i],i+=1,t.default_KID=[];for(var s=0;s<16;s++)t.default_KID.push(De(r[i])),i+=1})}},{key:"schi",value:function(e){return D(e,!1,function(t,r,i){t.tenc=n.tenc(n.findBox(r,["tenc"],i)[0])})}},{key:"sinf",value:function(e){return D(e,!1,function(t,r,i){t.schi=n.schi(n.findBox(r,["schi"],i)[0]),t.frma=n.frma(n.findBox(r,["frma"],i)[0])})}},{key:"frma",value:function(e){return D(e,!1,function(t,r){t.data_format="";for(var i=0;i<4;i++)t.data_format+=String.fromCharCode(r[i])})}},{key:"avc1",value:function(e){return D(e,!1,function(t,r,i){var s=Re(t,r),o=r.subarray(s);i+=s,t.avcC=n.avcC(n.findBox(o,["avcC"],i)[0]),t.pasp=n.pasp(n.findBox(o,["pasp"],i)[0])})}},{key:"avcC",value:function(e){return D(e,!1,function(t,r){t.data=e.data,t.configurationVersion=r[0],t.AVCProfileIndication=r[1],t.profileCompatibility=r[2],t.AVCLevelIndication=r[3],t.codec=qe([r[1],r[2],r[3]]),t.lengthSizeMinusOne=r[4]&3,t.spsLength=r[5]&31,t.sps=[];for(var i=6,s=0;s<t.spsLength;s++){var o=C(r,i);i+=2,t.sps.push(r.subarray(i,i+o)),i+=o}t.ppsLength=r[i],i+=1,t.pps=[];for(var u=0;u<t.ppsLength;u++){var l=C(r,i);i+=2,t.pps.push(r.subarray(i,i+=l)),i+=l}})}},{key:"hvc1",value:function(e){return D(e,!1,function(t,r,i){var s=Re(t,r),o=r.subarray(s);i+=s,t.hvcC=n.hvcC(n.findBox(o,["hvcC"],i)[0]),t.pasp=n.pasp(n.findBox(o,["pasp"],i)[0])})}},{key:"hvcC",value:function(e){return D(e,!1,function(t,r){t.data=e.data,t.codec="hev1.1.6.L93.B0",t.configurationVersion=r[0];var i=r[1];t.generalProfileSpace=i>>6,t.generalTierFlag=(i&32)>>5,t.generalProfileIdc=i&31,t.generalProfileCompatibility=m(r,2),t.generalConstraintIndicatorFlags=r.subarray(6,12),t.generalLevelIdc=r[12],t.avgFrameRate=C(r,19),t.numOfArrays=r[22],t.vps=[],t.sps=[],t.pps=[];for(var s=23,o=0,u=0,l=0,f=0;f<t.numOfArrays;f++){o=r[s]&63,u=C(r,s+1),s+=3;for(var d=[],v=0;v<u;v++)l=C(r,s),s+=2,d.push(r.subarray(s,s+l)),s+=l;if(o===32){var p;(p=t.vps).push.apply(p,d)}else if(o===33){var y;(y=t.sps).push.apply(y,d)}else if(o===34){var w;(w=t.pps).push.apply(w,d)}}})}},{key:"pasp",value:function(e){return D(e,!1,function(t,r){t.hSpacing=m(r),t.vSpacing=m(r,4)})}},{key:"mp4a",value:function(e){return D(e,!1,function(t,r,i){var s=Oe(t,r);t.esds=n.esds(n.findBox(r.subarray(s),["esds"],i+s)[0])})}},{key:"esds",value:function(e){return D(e,!0,function(t,r){t.codec="mp4a.";for(var i=0,s=0,o=0,u=0;r.length;){for(i=0,u=r[i],s=r[i+1],i+=2;s&128;)o=(s&127)<<7,s=r[i],i+=1;if(o+=s&127,u===3)r=r.subarray(i+3);else if(u===4)t.codec+=(r[i].toString(16)+".").padStart(3,"0"),r=r.subarray(i+13);else if(u===5){var l=t.config=r.subarray(i,i+o),f=(l[0]&248)>>3;f===31&&l.length>=2&&(f=32+((l[0]&7)<<3)+((l[1]&224)>>5)),t.objectType=f,t.codec+=f.toString(16),t.codec[t.codec.length-1]==="."&&(t.codec=t.codec.substring(0,t.codec.length-1));return}else{t.codec[t.codec.length-1]==="."&&(t.codec=t.codec.substring(0,t.codec.length-1));return}}})}},{key:"alaw",value:function(e){return D(e,!1,function(t,r){Oe(t,r)})}},{key:"stts",value:function(e){return D(e,!0,function(t,r){for(var i=m(r),s=[],o=4,u=0;u<i;u++)s.push({count:m(r,o),delta:m(r,o+4)}),o+=8;t.entryCount=i,t.entries=s})}},{key:"ctts",value:function(e){return D(e,!0,function(t,r){var i=m(r),s=[],o=4;if(t.version===1)for(var u=0;u<i;u++)s.push({count:m(r,o),offset:m(r,o+4)}),o+=8;else for(var l=0;l<i;l++)s.push({count:m(r,o),offset:-(~m(r,o+4)+1)}),o+=8;t.entryCount=i,t.entries=s})}},{key:"stsc",value:function(e){return D(e,!0,function(t,r){for(var i=m(r),s=[],o=4,u=0;u<i;u++)s.push({firstChunk:m(r,o),samplesPerChunk:m(r,o+4),sampleDescriptionIndex:m(r,o+8)}),o+=12;t.entryCount=i,t.entries=s})}},{key:"stsz",value:function(e){return D(e,!0,function(t,r){var i=m(r),s=m(r,4),o=[];if(!i)for(var u=8,l=0;l<s;l++)o.push(m(r,u)),u+=4;t.sampleSize=i,t.sampleCount=s,t.entrySizes=o})}},{key:"stco",value:function(e){return D(e,!0,function(t,r){for(var i=m(r),s=[],o=4,u=0;u<i;u++)s.push(m(r,o)),o+=4;t.entryCount=i,t.entries=s})}},{key:"co64",value:function(e){return D(e,!0,function(t,r){for(var i=m(r),s=[],o=4,u=0;u<i;u++)s.push(W(r,o)),o+=8;t.entryCount=i,t.entries=s})}},{key:"stss",value:function(e){return D(e,!0,function(t,r){for(var i=m(r),s=[],o=4,u=0;u<i;u++)s.push(m(r,o)),o+=4;t.entryCount=i,t.entries=s})}},{key:"moof",value:function(e){return D(e,!1,function(t,r,i){t.mfhd=n.mfhd(n.findBox(r,["mfhd"],i)[0]),t.traf=n.findBox(r,["traf"],i).map(function(s){return n.traf(s)})})}},{key:"mfhd",value:function(e){return D(e,!0,function(t,r){t.sequenceNumber=m(r)})}},{key:"traf",value:function(e){return D(e,!1,function(t,r,i){t.tfhd=n.tfhd(n.findBox(r,["tfhd"],i)[0]),t.tfdt=n.tfdt(n.findBox(r,["tfdt"],i)[0]),t.trun=n.trun(n.findBox(r,["trun"],i)[0])})}},{key:"trun",value:function(e){return D(e,!0,function(t,r){var i=t.version,s=t.flags,o=r.length,u=t.sampleCount=m(r),l=4;if(o>l&&s&1&&(t.dataOffset=-(~m(r,l)+1),l+=4),o>l&&s&4&&(t.firstSampleFlags=m(r,l),l+=4),t.samples=[],o>l)for(var f,d=0;d<u;d++)f={},s&256&&(f.duration=m(r,l),l+=4),s&512&&(f.size=m(r,l),l+=4),s&1024&&(f.flags=m(r,l),l+=4),s&2048&&(i?f.cts=-(~m(r,l+4)+1):f.cts=m(r,l),l+=4),t.samples.push(f)})}},{key:"tfdt",value:function(e){return D(e,!0,function(t,r){t.version===1?t.baseMediaDecodeTime=W(r):t.baseMediaDecodeTime=m(r)})}},{key:"probe",value:function(e){return!!n.findBox(e,["ftyp"])}},{key:"parseSampleFlags",value:function(e){return{isLeading:(e[0]&12)>>>2,dependsOn:e[0]&3,isDependedOn:(e[1]&192)>>>6,hasRedundancy:(e[1]&48)>>>4,paddingValue:(e[1]&14)>>>1,isNonSyncSample:e[1]&1,degradationPriority:e[2]<<8|e[3]}}},{key:"moovToTrack",value:function(e,t,r){var i,s,o=e.trak;if(!(!o||!o.length)){var u=o.find(function(be){var q,Z;return((q=be.mdia)===null||q===void 0||(Z=q.hdlr)===null||Z===void 0?void 0:Z.handlerType)==="vide"}),l=o.find(function(be){var q,Z;return((q=be.mdia)===null||q===void 0||(Z=q.hdlr)===null||Z===void 0?void 0:Z.handlerType)==="soun"});if(u&&t){var f,d,v,p,y,w,h,g=t,k=(f=u.tkhd)===null||f===void 0?void 0:f.trackId;k!=null&&(g.id=u.tkhd.trackId),g.tkhdDuration=u.tkhd.duration,g.mvhdDurtion=e.mvhd.duration,g.mvhdTimecale=e.mvhd.timescale,g.timescale=g.formatTimescale=u.mdia.mdhd.timescale,g.duration=u.mdia.mdhd.duration||g.mvhdDurtion/g.mvhdTimecale*g.timescale;var b=u.mdia.minf.stbl.stsd.entries[0];if(g.width=b.width,g.height=b.height,b.pasp&&(g.sarRatio=[b.pasp.hSpacing,b.pasp.vSpacing]),b.hvcC)g.codecType=X.HEVC,g.codec=b.hvcC.codec,g.vps=b.hvcC.vps,g.sps=b.hvcC.sps,g.pps=b.hvcC.pps,g.hvcC=b.hvcC.data;else if(b.avcC)g.codec=b.avcC.codec,g.sps=b.avcC.sps,g.pps=b.avcC.pps;else throw new Error("unknown video stsd entry");if(g.present=!0,g.ext={},g.ext.stss=(d=u.mdia)===null||d===void 0||(v=d.minf)===null||v===void 0||(p=v.stbl)===null||p===void 0?void 0:p.stss,g.ext.ctts=(y=u.mdia)===null||y===void 0||(w=y.minf)===null||w===void 0||(h=w.stbl)===null||h===void 0?void 0:h.ctts,b&&b.type==="encv"){var S,A,P,B,U,V,M,R;g.isVideoEncryption=!0,b.default_KID=(S=b.sinf)===null||S===void 0||(A=S.schi)===null||A===void 0?void 0:A.tenc.default_KID,b.default_IsEncrypted=(P=b.sinf)===null||P===void 0||(B=P.schi)===null||B===void 0?void 0:B.tenc.default_IsEncrypted,b.default_IV_size=(U=b.sinf)===null||U===void 0||(V=U.schi)===null||V===void 0?void 0:V.tenc.default_IV_size,g.videoSenc=u.mdia.minf.stbl.senc&&u.mdia.minf.stbl.senc.samples,b.data_format=(M=b.sinf)===null||M===void 0||(R=M.frma)===null||R===void 0?void 0:R.data_format,g.useEME=e.useEME,g.kidValue=e.kidValue,g.pssh=e.pssh,g.encv=b}}if(l&&r){var O,j,re,ne,ie,se,ae,oe,ue,x=r,Ce=(O=l.tkhd)===null||O===void 0?void 0:O.trackId;Ce!=null&&(x.id=l.tkhd.trackId),x.tkhdDuration=l.tkhd.duration,x.mvhdDurtion=e.mvhd.duration,x.mvhdTimecale=e.mvhd.timescale,x.timescale=x.formatTimescale=l.mdia.mdhd.timescale,x.duration=l.mdia.mdhd.duration||x.mvhdDurtion/x.mvhdTimecale*x.timescale;var _=l.mdia.minf.stbl.stsd.entries[0];switch(x.sampleSize=_.sampleSize,x.sampleRate=_.sampleRate,x.channelCount=_.channelCount,x.present=!0,_.type){case"alaw":x.codecType=x.codec=$.G711PCMA,x.sampleRate=8e3;break;case"ulaw":x.codecType=x.codec=$.G711PCMU,x.sampleRate=8e3;break;default:x.sampleDuration=H.getFrameDuration(x.sampleRate,x.timescale),x.sampleRateIndex=H.getRateIndexByRate(x.sampleRate),x.objectType=((i=_.esds)===null||i===void 0?void 0:i.objectType)||2,_.esds&&(x.config=Array.from(_.esds.config)),x.codec=((s=_.esds)===null||s===void 0?void 0:s.codec)||"mp4a.40.2";break}if(x.sampleDuration=H.getFrameDuration(x.sampleRate,x.timescale),x.objectType=((j=_.esds)===null||j===void 0?void 0:j.objectType)||2,_.esds&&_.esds.config&&(x.config=Array.from(_.esds.config)),x.codec=((re=_.esds)===null||re===void 0?void 0:re.codec)||"mp4a.40.2",x.sampleRateIndex=H.getRateIndexByRate(x.sampleRate),x.ext={},x.ext.stss=(ne=l.mdia)===null||ne===void 0||(ie=ne.minf)===null||ie===void 0||(se=ie.stbl)===null||se===void 0?void 0:se.stss,x.ext.ctts=(ae=l.mdia)===null||ae===void 0||(oe=ae.minf)===null||oe===void 0||(ue=oe.stbl)===null||ue===void 0?void 0:ue.ctts,x.present=!0,_&&_.type==="enca"){var le,fe,ve,ce,he,pe,de,me;x.isAudioEncryption=!0,_.data_format=(le=_.sinf)===null||le===void 0||(fe=le.frma)===null||fe===void 0?void 0:fe.data_format,_.default_KID=(ve=_.sinf)===null||ve===void 0||(ce=ve.schi)===null||ce===void 0?void 0:ce.tenc.default_KID,_.default_IsEncrypted=(he=_.sinf)===null||he===void 0||(pe=he.schi)===null||pe===void 0?void 0:pe.tenc.default_IsEncrypted,_.default_IV_size=(de=_.sinf)===null||de===void 0||(me=de.schi)===null||me===void 0?void 0:me.tenc.default_IV_size,x.audioSenc=l.mdia.minf.stbl.senc&&l.mdia.minf.stbl.senc.samples,x.useEME=e.useEME,x.kidValue=e.kidValue,x.enca=_}}if(r&&(r.isVideoEncryption=t?t.isVideoEncryption:!1),t&&(t.isAudioEncryption=r?r.isAudioEncryption:!1),t!=null&&t.encv||r!=null&&r.enca){var ye,ge,Pe=t==null||(ye=t.encv)===null||ye===void 0?void 0:ye.default_KID,Ue=r==null||(ge=r.enca)===null||ge===void 0?void 0:ge.default_KID,_e=Pe||Ue?(Pe||Ue).join(""):null;t&&(t.kid=_e),r&&(r.kid=_e)}return t&&(t.flags=3841),r&&(r.flags=1793),{videoTrack:t,audioTrack:r}}}},{key:"evaluateDefaultDuration",value:function(e,t,r){var i,s=t==null||(i=t.samples)===null||i===void 0?void 0:i.length;if(!s)return 1024;var o=1024*s/t.timescale;return o*e.timescale/r}},{key:"moofToSamples",value:function(e,t,r){var i={};return e.mfhd&&(t&&(t.sequenceNumber=e.mfhd.sequenceNumber),r&&(r.sequenceNumber=e.mfhd.sequenceNumber)),e.traf.forEach(function(s){var o=s.tfhd,u=s.tfdt,l=s.trun;if(!(!o||!l)){u&&(t&&t.id===o.trackId&&(t.baseMediaDecodeTime=u.baseMediaDecodeTime),r&&r.id===o.trackId&&(r.baseMediaDecodeTime=u.baseMediaDecodeTime));var f=o.defaultSampleSize||0,d=o.defaultSampleDuration||n.evaluateDefaultDuration(t,r,l.samples.length||l.sampleCount),v=l.dataOffset||0,p=0,y=-1;if(!l.samples.length&&l.sampleCount){i[o.trackId]=[];for(var w=0;w<l.sampleCount;w++)i[o.trackId].push({offset:v,dts:p,duration:d,size:f}),p+=d,v+=f}else i[o.trackId]=l.samples.map(function(h,g){return h={offset:v,dts:p,pts:p+(h.cts||0),duration:h.duration||d,size:h.size||f,gopId:y,keyframe:g===0||h.flags!==null&&h.flags!==void 0&&(h.flags&65536)>>>0!==65536},h.keyframe&&(y++,h.gopId=y),p+=h.duration,v+=h.size,h})}}),i}},{key:"moovToSamples",value:function(e){var t=e.trak;if(!(!t||!t.length)){var r=t.find(function(M){var R,O;return((R=M.mdia)===null||R===void 0||(O=R.hdlr)===null||O===void 0?void 0:O.handlerType)==="vide"}),i=t.find(function(M){var R,O;return((R=M.mdia)===null||R===void 0||(O=R.hdlr)===null||O===void 0?void 0:O.handlerType)==="soun"});if(!(!r&&!i)){var s,o;if(r){var u,l,f=(u=r.mdia)===null||u===void 0||(l=u.minf)===null||l===void 0?void 0:l.stbl;if(!f)return;var d=f.stts,v=f.stsc,p=f.stsz,y=f.stco,w=f.stss,h=f.ctts;if(!d||!v||!p||!y||!w)return;s=Le(d,v,p,y,h,w)}if(i){var g,k,b,S=(g=i.mdia)===null||g===void 0||(k=g.minf)===null||k===void 0?void 0:k.stbl;if(!S)return;var A=(b=i.mdia.mdhd)===null||b===void 0?void 0:b.timescale,P=S.stts,B=S.stsc,U=S.stsz,V=S.stco;if(!A||!P||!B||!U||!V)return;o=Le(P,B,U,V)}return{videoSamples:s,audioSamples:o}}}}}]),n}();function Le(n,a,e,t,r,i){var s=[],o=r==null?void 0:r.entries,u=a.entries,l=t.entries,f=e.entrySizes,d=i==null?void 0:i.entries,v;d&&(v={},d.forEach(function(B){v[B-1]=!0}));var p;o&&(p=[],o.forEach(function(B){for(var U=B.count,V=B.offset,M=0;M<U;M++)p.push(V)}));var y,w=-1,h=0,g=0,k=0,b=0,S=0,A=u[0].samplesPerChunk,P=u[1]?u[1].firstChunk-1:1/0;return n.entries.forEach(function(B){for(var U=B.count,V=B.delta,M=0;M<U;M++)y={dts:h,duration:V,size:f[g]||e.sampleSize,offset:l[k]+S,index:g},d&&(y.keyframe=v[g],y.keyframe&&w++,y.gopId=w),p&&g<p.length&&(y.pts=y.dts+p[g]),s.push(y),h+=V,g++,g<A?S+=y.size:(k++,S=0,k>=P&&(b++,P=u[b+1]?u[b+1].firstChunk-1:1/0),A+=u[b].samplesPerChunk)}),s}function Re(n,a){return n.dataReferenceIndex=C(a,6),n.width=C(a,24),n.height=C(a,26),n.horizresolution=m(a,28),n.vertresolution=m(a,32),n.frameCount=C(a,40),n.depth=C(a,74),78}function Oe(n,a){return n.dataReferenceIndex=C(a,6),n.channelCount=C(a,16),n.sampleSize=C(a,18),n.sampleRate=m(a,24)/65536,28}function D(n,a,e){if(n){if(n.size!==n.data.length)throw new Error("box ".concat(n.type," size !== data.length"));var t={start:n.start,size:n.size,headerSize:n.headerSize,type:n.type};return a&&(t.version=n.data[n.headerSize],t.flags=pt(n.data,n.headerSize+1),t.headerSize+=4),e(t,n.data.subarray(t.headerSize),t.start+t.headerSize),t}}var bt=function(a,e,t){for(var r=String(t),i=e>>0,s=Math.ceil(i/r.length),o=[],u=String(a);s--;)o.push(r);return o.join("").substring(0,i-u.length)+u},De=function(){for(var a=[],e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.forEach(function(i){a.push(bt(Number(i).toString(16),2,0))}),a[0]},xt=function(){function n(a,e,t){I(this,n),this.videoTrack=a||new Ne,this.audioTrack=e||new He,this.metadataTrack=t||new Ke}return T(n,[{key:"demux",value:function(e,t){var r=this.videoTrack,i=this.audioTrack,s=r.exist(),o=i.exist();if(r.samples=[],i.samples=[],t){if(!o){var u=z.findBox(t,["moov"])[0];if(!u)throw new Error("cannot found moov box");z.moovToTrack(z.moov(u),null,i)}var l=z.findBox(t,["moof"])[0];if(l){var f=z.moofToSamples(z.moof(l),null,i)[i.id],d=i.baseMediaDecodeTime;if(f){var v=l.start;f.map(function(S){S.offset+=v;var A=t.subarray(S.offset,S.offset+S.size);i.samples.push(new ee(S.dts+d,A,S.duration))})}}}if(e){if(!s&&!o){var p=z.findBox(e,["moov"])[0];if(!p)throw new Error("cannot found moov box");z.moovToTrack(z.moov(p),r,i)}var y=z.findBox(e,["moof"])[0];if(y){var w=z.moofToSamples(z.moof(y),r,i),h=r.baseMediaDecodeTime,g=i.baseMediaDecodeTime,k=y.start,b;Object.keys(w).forEach(function(S){r.id==S?w[S].map(function(A){A.offset+=k;var P=new We((A.pts||A.dts)+h,A.dts+h);P.duration=A.duration,P.gopId=A.gopId,A.keyframe&&P.setToKeyframe();var B=e.subarray(A.offset,A.offset+A.size);P.data=B;for(var U=0,V=B.length-1;U<V;)b=m(B,U),U+=4,P.units.push(B.subarray(U,U+b)),U+=b;r.samples.push(P)}):i.id==S&&w[S].map(function(A){A.offset+=k;var P=e.subarray(A.offset,A.offset+A.size);i.samples.push(new ee(A.dts+g,P,A.duration))})})}}return{videoTrack:r,audioTrack:i,metadataTrack:this.metadataTrack}}},{key:"reset",value:function(){this.videoTrack.reset(),this.audioTrack.reset(),this.metadataTrack.reset()}}],[{key:"probe",value:function(e){return z.probe(e)}}]),n}();function At(n){for(var a=0,e=arguments.length,t=new Array(e>1?e-1:0),r=1;r<e;r++)t[r-1]=arguments[r];t.forEach(function(o){a+=o.length});var i=new n(a),s=0;return t.forEach(function(o){i.set(o,s),s+=o.length}),i}var L=function(){function n(){I(this,n),this.buffer=new Uint8Array(0)}return T(n,[{key:"write",value:function(){for(var e=this,t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];r.forEach(function(s){s?e.buffer=At(Uint8Array,e.buffer,s):window.console.warn(s)})}}],[{key:"writeUint16",value:function(e){return new Uint8Array([e>>8&255,e&255])}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,e&255])}}]),n}(),ze=Math.pow(2,32)-1,E=function(){function n(){I(this,n)}return T(n,null,[{key:"box",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];r=r.filter(Boolean);var s=8+r.reduce(function(l,f){return l+f.byteLength},0),o=new Uint8Array(s);o[0]=s>>24&255,o[1]=s>>16&255,o[2]=s>>8&255,o[3]=s&255,o.set(e,4);var u=8;return r.forEach(function(l){o.set(l,u),u+=l.byteLength}),o}},{key:"ftyp",value:function(e){var t=e.find(function(r){return r.type===Q.VIDEO&&r.codecType===X.HEVC});return t?n.FTYPHEV1:n.FTYPAVC1}},{key:"initSegment",value:function(e){var t=n.ftyp(e),r=G(t,n.moov(e));return r}},{key:"pssh",value:function(e){var t=new Uint8Array([1,0,0,0].concat([16,119,239,236,192,178,77,2,172,227,60,30,82,226,251,75],[0,0,0,1],Te(e.kid),[0,0,0,0]));return n.box(n.types.pssh,t)}},{key:"moov",value:function(e){if(e[0].useEME&&(e[0].encv||e[0].enca)){e[0].pssh||(e[0].pssh={kid:e[0].kid});var t=this.pssh(e[0].pssh);return n.box.apply(n,[n.types.moov,n.mvhd(e[0].mvhdDurtion||e[0].duration,e[0].mvhdTimecale||e[0].timescale),n.mvex(e)].concat(F(e.map(function(r){return n.trak(r)})),[t]))}else return n.box.apply(n,[n.types.moov,n.mvhd(e[0].mvhdDurtion||e[0].duration,e[0].mvhdTimecale||e[0].timescale)].concat(F(e.map(function(r){return n.trak(r)})),[n.mvex(e)]))}},{key:"mvhd",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9e4,r=n.box(n.types.mvhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255,e>>24&255,e>>16&255,e>>8&255,e&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]));return r}},{key:"trak",value:function(e){var t=n.box(n.types.trak,n.tkhd(e.id,e.tkhdDuration||0,e.width,e.height),n.mdia(e));return t}},{key:"tkhd",value:function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,s=n.box(n.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,e>>24&255,e>>16&255,e>>8&255,e&255,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,r&255,0,0,i>>8&255,i&255,0,0]));return s}},{key:"mdia",value:function(e){var t=n.box(n.types.mdia,n.mdhd(e.duration,e.timescale),n.hdlr(e.type),n.minf(e));return t}},{key:"mdhd",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9e4,r=n.box(n.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255,e>>24&255,e>>16&255,e>>8&255,e&255,85,196,0,0]));return r}},{key:"hdlr",value:function(e){var t=n.box(n.types.hdlr,n.HDLR_TYPES[e]);return t}},{key:"minf",value:function(e){var t=n.box(n.types.minf,e.type===Q.VIDEO?n.VMHD:n.SMHD,n.DINF,n.stbl(e));return t}},{key:"stbl",value:function(e){var t=[];e&&e.ext&&e.ext.stss&&t.push(n.stss(e.ext.stss.entries));var r=n.box(n.types.stbl,n.stsd(e),n.STTS,t[0],n.STSC,n.STSZ,n.STCO);return r}},{key:"stsd",value:function(e){var t;e.type==="audio"?e.useEME&&e.enca?t=n.enca(e):t=n.mp4a(e):e.useEME&&e.encv?t=n.encv(e):t=n.avc1hev1(e);var r=n.box(n.types.stsd,new Uint8Array([0,0,0,0,0,0,0,1]),t);return r}},{key:"enca",value:function(e){var t=e.enca.channelCount,r=e.enca.sampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t,0,16,0,0,0,0,r>>8&255,r&255,0,0]),s=n.esds(e.config),o=n.sinf(e.enca);return n.box(n.types.enca,i,s,o)}},{key:"encv",value:function(e){var t,r,i=e.sps.length>0?e.sps[0]:[],s=e.pps.length>0?e.pps[0]:[],o=e.width,u=e.height,l=e.sarRatio[0],f=e.sarRatio[1],d=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,o&255,u>>8&255,u&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),v=new Uint8Array((t=(r=[1,i[1],i[2],i[3],255,225,i.length>>>8&255,i.length&255]).concat.apply(r,F(i)).concat([1,s.length>>>8&255,s.length&255])).concat.apply(t,F(s))),p=new Uint8Array([0,0,88,57,0,15,200,192,0,4,86,72]),y=n.sinf(e.encv),w=new Uint8Array([l>>24,l>>16&255,l>>8&255,l&255,f>>24,f>>16&255,f>>8&255,f&255]);return n.box(n.types.encv,d,n.box(n.types.avcC,v),n.box(n.types.btrt,p),y,n.box(n.types.pasp,w))}},{key:"schi",value:function(e){var t=new Uint8Array([]),r=n.tenc(e);return n.box(n.types.schi,t,r)}},{key:"tenc",value:function(e){var t=new Uint8Array([0,0,0,0,0,0,e.default_IsEncrypted&255,e.default_IV_size&255].concat(Te(e.default_KID)));return n.box(n.types.tenc,t)}},{key:"sinf",value:function(e){var t=new Uint8Array([]),r=new Uint8Array([e.data_format.charCodeAt(0),e.data_format.charCodeAt(1),e.data_format.charCodeAt(2),e.data_format.charCodeAt(3)]),i=new Uint8Array([0,0,0,0,99,101,110,99,0,1,0,0]),s=n.schi(e);return n.box(n.types.sinf,t,n.box(n.types.frma,r),n.box(n.types.schm,i),s)}},{key:"avc1hev1",value:function(e){var t=e.codecType===X.HEVC,r=t?n.types.hvc1:n.types.avc1,i=t?n.hvcC(e):n.avcC(e),s=[new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,e.width>>8&255,e.width&255,e.height>>8&255,e.height&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),i];return t?s.push(n.box(n.types.fiel,new Uint8Array([1,0]))):e.sarRatio&&e.sarRatio.length>1&&s.push(n.pasp(e.sarRatio)),n.box.apply(n,[r].concat(s))}},{key:"avcC",value:function(e){var t,r,i=[],s=[],o;return e.sps.forEach(function(u){o=u.byteLength,i.push(o>>>8&255),i.push(o&255),i.push.apply(i,F(u))}),e.pps.forEach(function(u){o=u.byteLength,s.push(o>>>8&255),s.push(o&255),s.push.apply(s,F(u))}),n.box(n.types.avcC,new Uint8Array((t=(r=[1,i[3],i[4],i[5],255,224|e.sps.length]).concat.apply(r,i).concat([e.pps.length])).concat.apply(t,s)))}},{key:"hvcC",value:function(e){var t=e.hvcC;if(t instanceof ArrayBuffer||t instanceof Uint8Array)return t;var r=e.vps,i=e.sps,s=e.pps,o;if(t){var u=t.generalProfileCompatibilityFlags,l=t.generalConstraintIndicatorFlags,f=(r.length&&1)+(i.length&&1)+(s.length&&1);o=[1,t.generalProfileSpace<<6|t.generalTierFlag<<5|t.generalProfileIdc,u>>>24,u>>>16,u>>>8,u,l[0],l[1],l[2],l[3],l[4],l[5],t.generalLevelIdc,240,0,252,t.chromaFormatIdc|252,t.bitDepthLumaMinus8|248,t.bitDepthChromaMinus8|248,0,0,t.numTemporalLayers<<3|t.temporalIdNested<<2|3,f];var d=function(p){var y;o.push(p.length>>8,p.length),(y=o).push.apply(y,F(p))};r.length&&(o.push(160,0,r.length),r.forEach(d)),i.length&&(o.push(161,0,i.length),i.forEach(d)),s.length&&(o.push(162,0,s.length),s.forEach(d))}else o=[1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64];return n.box(n.types.hvcC,new Uint8Array(o))}},{key:"pasp",value:function(e){var t=tt(e,2),r=t[0],i=t[1];return n.box(n.types.pasp,new Uint8Array([r>>24,r>>16&255,r>>8&255,r&255,i>>24,i>>16&255,i>>8&255,i&255]))}},{key:"mp4a",value:function(e){return n.box(n.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,e.sampleRate>>8&255,e.sampleRate&255,0,0]),e.config.length?n.esds(e.config):void 0)}},{key:"esds",value:function(e){var t=e.length,r=n.box(n.types.esds,new Uint8Array([0,0,0,0,3,23+t,0,0,0,4,15+t,64,21,0,6,0,0,0,218,192,0,0,218,192,5].concat([t]).concat(e).concat([6,1,2])));return r}},{key:"mvex",value:function(e){var t=n.box.apply(n,[n.types.mvex].concat(F(e.map(function(r){return n.trex(r.id)}))));return t}},{key:"trex",value:function(e){var t=n.box(n.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]));return t}},{key:"trex1",value:function(e){var t=n.box(n.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,2,0,0,0,0,0,0,1,0,0]));return t}},{key:"trex2",value:function(e){var t=n.box(n.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,4,0,0,0,0,0,2,0,0,0]));return t}},{key:"moof",value:function(e){var t=n.box.apply(n,[n.types.moof,n.mfhd(e[0].samples?e[0].samples[0].gopId:0)].concat(F(e.map(function(r){return n.traf(r)}))));return t}},{key:"mfhd",value:function(e){var t=n.box(n.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]));return t}},{key:"traf",value:function(e){var t=n.tfhd(e.id),r=n.tfdt(e,e.baseMediaDecodeTime),i=0,s;if(e.isVideo&&e.videoSenc&&(s=e.videoSenc,s.forEach(function(j){i=i+8,j.subsamples&&j.subsamples.length&&(i=i+2,i=i+j.subsamples.length*6)})),e.videoSencLength=i,!e.useEME||!e.isVideoEncryption&&!e.isAudioEncryption){var o=n.sdtp(e),u=76;return n.box(n.types.traf,t,r,o,n.trun(e.samples,o.byteLength+u))}else if(e.isVideoEncryption)if(e.isVideo){var l=n.saiz(e),f=n.saio(e),d=n.trun1(e),v=n.senc(e),p=n.box(n.types.traf,t,r,l,f,d,v);return p}else if(e.isAudioEncryption){var h=n.sbgp(),g=n.saiz(e),k=n.saio(e),b=n.senc(e),S=n.trun1(e),A=n.box(n.types.traf,t,r,h,g,k,b,S);return A}else{var y=n.sbgp(),w=n.trun1(e);return n.box(n.types.traf,t,r,y,w)}else if(e.isVideo){var P=n.trun1(e);return n.box(n.types.traf,t,r,P)}else{var B=n.sbgp(),U=n.saiz(e),V=n.saio(e),M=n.senc(e),R=n.trun1(e),O=n.box(n.types.traf,t,r,B,U,V,M,R);return O}}},{key:"sdtp",value:function(e){var t=new L;return e.samples.forEach(function(r){t.write(new Uint8Array(e.isVideo?[r.keyframe?32:16]:[16]))}),n.box(n.types.sdtp,this.extension(0,0),t.buffer)}},{key:"trun1",value:function(e){var t=new L,r=L.writeUint32(e.samples.length),i=null;if(e.isVideo){var s=e.videoSencLength;i=L.writeUint32(e.samples.length*16+s+149),!e.isVideoEncryption&&e.isAudioEncryption&&(i=L.writeUint32(e.samples.length*16+92))}else{var o=e.samples.length*12+124;e.isAudioEncryption&&(o=e.samples.length*12+8*e.audioSenc.length+177),i=L.writeUint32(o)}return e.samples.forEach(function(u){t.write(L.writeUint32(u.duration)),t.write(L.writeUint32(u.size)),t.write(L.writeUint32(u.keyframe?33554432:65536)),e.isVideo&&t.write(L.writeUint32(u.cts?u.cts:0))}),n.box(n.types.trun,this.extension(0,e.flags),r,i,t.buffer)}},{key:"senc",value:function(e){var t=new L,r=e.samples.length,i=e.isVideo?16:8,s=e.isVideo?2:0,o=[],u=0;return e.isVideo?(o=e.videoSenc,u=e.videoSencLength):o=e.audioSenc,u=u||i*r,t.write(L.writeUint32(16+u),n.types.senc,this.extension(0,s)),t.write(L.writeUint32(r)),o.forEach(function(l){for(var f=0;f<l.InitializationVector.length;f++)t.write(new Uint8Array([l.InitializationVector[f]]));l.subsamples&&l.subsamples.length&&(t.write(L.writeUint16(l.subsamples.length)),l.subsamples.forEach(function(d){t.write(L.writeUint16(d.BytesOfClearData)),t.write(L.writeUint32(d.BytesOfProtectedData))}))}),t.buffer}},{key:"saio",value:function(e){var t=e.samples.length*12+141;!e.isVideo&&e.isAudioEncryption&&(t=149);var r=new Uint8Array([1,0,0,0,0,0,0,1,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255]);return n.box(n.types.saio,r)}},{key:"saiz",value:function(e){var t=e.samples.length,r=new Uint8Array([0,0,0,0,16,t>>24&255,t>>16&255,t>>8&255,t&255]);return n.box(n.types.saiz,r)}},{key:"sbgp",value:function(){var e=new Uint8Array([114,111,108,108,0,0,0,1,0,0,1,25,0,0,0,1]);return n.box(n.types.sbgp,this.extension(0,0),e)}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,t&255])}},{key:"tfhd",value:function(e){return n.box(n.types.tfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}},{key:"tfdt",value:function(e,t){var r=Math.floor(t/(ze+1)),i=Math.floor(t%(ze+1));return e.useEME&&(e.isVideoEncryption||e.isAudioEncryption)?n.box(n.types.tfdt,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,i&255])):n.box(n.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,i>>24,i>>16&255,i>>8&255,i&255]))}},{key:"trun",value:function(e,t){var r=e.length,i=12+16*r;t+=8+i;var s=new Uint8Array(i);s.set([0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,r&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0);for(var o=0;o<r;o++){var u=e[o],l=u.duration,f=u.size,d=u.flag,v=d===void 0?{}:d,p=u.cts,y=p===void 0?0:p;s.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,f>>>24&255,f>>>16&255,f>>>8&255,f&255,v.isLeading<<2|(v.dependsOn===null||v.dependsOn===void 0?1:v.dependsOn),v.isDependedOn<<6|v.hasRedundancy<<4|v.paddingValue<<1|(v.isNonSyncSample===null||v.isNonSyncSample===void 0?1:v.isNonSyncSample),v.degradationPriority&61440,v.degradationPriority&15,y>>>24&255,y>>>16&255,y>>>8&255,y&255],12+16*o)}return n.box(n.types.trun,s)}},{key:"moovMP4",value:function(e){return n.box.apply(n,[n.types.moov,n.mvhd(e[0].duration,e[0].timescale)].concat(F(e.map(function(t){return n.trackMP4(t)}))))}},{key:"trackMP4",value:function(e){return n.box(n.types.trak,n.tkhd(e.id,e.duration,e.width,e.height),n.mdiaMP4(e))}},{key:"mdiaMP4",value:function(e){return n.box(n.types.mdia,n.mdhd(e.duration,e.timescale),n.hdlr(e.type),n.minfMP4(e))}},{key:"minfMP4",value:function(e){return n.box(n.types.minf,e.type===Q.VIDEO?n.VMHD:n.SMHD,n.DINF,n.stblMP4(e))}},{key:"stblMP4",value:function(e){var t=e.ext,r=[n.stsd(e),n.stts(t.stts),n.stsc(t.stsc),n.stsz(t.stsz),n.stco(t.stco)];return t.stss.length&&r.push(n.stss(t.stss)),t.ctts.length&&r.push(n.ctts(t.ctts)),n.box.apply(n,[n.types.stbl].concat(r))}},{key:"stts",value:function(e){var t=e.length,r=new Uint8Array(8*t),i=0;return e.forEach(function(s){var o=s.value,u=s.count;r.set([u>>24,u>>16&255,u>>8&255,u&255,o>>24,o>>16&255,o>>8&255,o&255],i),i+=8}),n.box(n.types.stts,G(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stsc",value:function(e){var t=e.length,r=new Uint8Array(12*t),i=0;return e.forEach(function(s){var o=s.firstChunk,u=s.samplesPerChunk,l=s.sampleDescIndex;r.set([o>>24,o>>16&255,o>>8&255,o&255,u>>24,u>>16&255,u>>8&255,u&255,l>>24,l>>16&255,l>>8&255,l&255],i),i+=12}),n.box(n.types.stsc,G(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stsz",value:function(e){var t=e.length,r=new Uint8Array(4*t),i=0;return e.forEach(function(s){r.set([s>>24,s>>16&255,s>>8&255,s&255],i),i+=4}),n.box(n.types.stsz,G(new Uint8Array([0,0,0,0,0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stco",value:function(e){var t=e.length,r=new Uint8Array(4*t),i=0;return e.forEach(function(s){r.set([s>>24,s>>16&255,s>>8&255,s&255],i),i+=4}),n.box(n.types.stco,G(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stss",value:function(e){var t=e.length,r=new Uint8Array(4*t),i=0;return e.forEach(function(s){r.set([s>>24,s>>16&255,s>>8&255,s&255],i),i+=4}),n.box(n.types.stss,G(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"ctts",value:function(e){var t=e.length,r=new Uint8Array(8*t),i=0;return e.forEach(function(s){var o=s.value,u=s.count;r.set([u>>24,u>>16&255,u>>8&255,u&255,o>>24,o>>16&255,o>>8&255,o&255],i),i+=8}),n.box(n.types.ctts,G(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"styp",value:function(){return n.box(n.types.styp,new Uint8Array([109,115,100,104,0,0,0,0,109,115,100,104,109,115,105,120]))}},{key:"sidx",value:function(e){var t=e.timescale,r=e.samples[0].duration,i=r*e.samples.length,s=e.samples[0].sampleOffset*r,o=8;e.samples.forEach(function(v){o+=v.size});var u=0;if(e.isVideo){var l=0,f;e.videoSenc&&(f=e.videoSenc),e.isVideo&&f.forEach(function(v){l=l+8,v.subsamples&&v.subsamples.length&&(l=l+2,l=l+v.subsamples.length*6)}),e.videoSencLength=l,u=o+141+e.samples.length*16+l,e.useEME&&e.isAudioEncryption&&!e.isVideoEncryption&&(u=o+e.samples.length*16+84)}else u=o+116+e.samples.length*12,e.useEME&&e.isAudioEncryption&&(u=o+169+e.samples.length*12+8*e.audioSenc.length);var d=new Uint8Array([0,0,0,0,0,0,0,e.id&255,t>>24&255,t>>16&255,t>>8&255,t&255,s>>24&255,s>>16&255,s>>8&255,s&255,0,0,0,0,0,0,0,1,0,u>>16&255,u>>8&255,u&255,i>>24&255,i>>16&255,i>>8&255,i&255,144,0,0,0]);return n.box(n.types.sidx,d)}},{key:"mdat",value:function(e){var t=n.box(n.types.mdat,e);return t}}]),n}();c(E,"types",["avc1","avcC","hvc1","hvcC","dinf","dref","esds","ftyp","hdlr","mdat","mdhd","mdia","mfhd","minf","moof","moov","mp4a","mvex","mvhd","pasp","stbl","stco","stsc","stsd","stsz","stts","tfdt","tfhd","traf","trak","trex","tkhd","vmhd","smhd","ctts","stss","styp","pssh","sidx","sbgp","saiz","saio","senc","trun","encv","enca","sinf","btrt","frma","tenc","schm","schi","mehd","fiel","sdtp"].reduce(function(n,a){return n[a]=[a.charCodeAt(0),a.charCodeAt(1),a.charCodeAt(2),a.charCodeAt(3)],n},Object.create(null)));c(E,"HDLR_TYPES",{video:new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])});c(E,"FTYPAVC1",E.box(E.types.ftyp,new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49])));c(E,"FTYPHEV1",E.box(E.types.ftyp,new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,104,101,118,49])));c(E,"DINF",E.box(E.types.dinf,E.box(E.types.dref,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]))));c(E,"VMHD",E.box(E.types.vmhd,new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])));c(E,"SMHD",E.box(E.types.smhd,new Uint8Array([0,0,0,0,0,0,0,0])));c(E,"StblTable",new Uint8Array([0,0,0,0,0,0,0,0]));c(E,"STTS",E.box(E.types.stts,E.StblTable));c(E,"STSC",E.box(E.types.stsc,E.StblTable));c(E,"STSZ",E.box(E.types.stsz,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0])));c(E,"STCO",E.box(E.types.stco,E.StblTable));var Ze=function(){function n(a,e){I(this,n),this.name=a||"",this._prefix="[".concat(this.name,"]"),n.disabled=e}return T(n,[{key:"debug",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).debug.apply(e,[this._prefix].concat(r))}}},{key:"log",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).log.apply(e,[this._prefix].concat(r))}}},{key:"warn",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).warn.apply(e,[this._prefix].concat(r))}}},{key:"error",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).error.apply(e,[this._prefix].concat(r))}}},{key:"table",value:function(){var e;n.disabled||(e=console).table.apply(e,arguments)}}],[{key:"enable",value:function(){n.disabled=!1}},{key:"disable",value:function(){n.disabled=!0}}]),n}();c(Ze,"disabled",!0);var Dt=function(){function n(a,e,t){I(this,n),this.videoTrack=a,this.audioTrack=e;var r=/Chrome\/([^.]+)/.exec(navigator.userAgent);this.forceFirstIDR=r&&Number(r[1])<50,this.log=new Ze("FMP4Remuxer",t&&t.openLog?!t.openLog:!0)}return T(n,[{key:"remux",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=this.videoTrack,i=this.audioTrack,s=r.exist(),o=i.exist(),u,l,f,d=[];e&&(t&&t.initMerge?(s&&d.push(this.videoTrack),o&&d.push(this.audioTrack),f=E.initSegment(d)):(s&&(u=E.initSegment([this.videoTrack])),o&&(l=E.initSegment([this.audioTrack]))));var v,p;return s&&r.hasSample()&&(v=this._remuxVideo()),o&&i.hasSample()&&(p=this._remuxAudio()),r.samples=[],i.samples=[],{initSegment:f,videoInitSegment:u,audioInitSegment:l,videoSegment:v,audioSegment:p}}},{key:"_remuxVideo",value:function(){var e=this.videoTrack;this.forceFirstIDR&&(e.samples[0].flag={dependsOn:2,isNonSyncSample:0});var t=e.samples,r=0;t.forEach(function(y){r+=y.units.reduce(function(w,h){return w+h.byteLength},0),r+=y.units.length*4});for(var i=new Uint8Array(r),s=new DataView(i.buffer),o=function(w,h){h=t[u];var g=0;h.units.forEach(function(k){s.setUint32(w,k.byteLength),w+=4,i.set(k,w),w+=k.byteLength,g+=4+k.byteLength}),h.size=g,f=w,d=h},u=0,l=t.length,f=0,d;u<l;u++)o(f,d);var v=E.mdat(i),p=E.moof([e]);return G(p,v)}},{key:"_remuxAudio",value:function(){var e=this.audioTrack,t=new Uint8Array(e.samples.reduce(function(s,o){return s+o.size},0));e.samples.reduce(function(s,o){return t.set(o.data,s),s+o.size},0);var r=E.mdat(t),i=E.moof([e]);return G(i,r)}},{key:"reset",value:function(){this.videoTrack.reset(),this.audioTrack.reset()}}]),n}();export{xt as F,je as L,z as M,Q as T,Y as W,wt as a,Dt as b};
