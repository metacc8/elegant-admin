
/**
 * 由 MrZhang 提供技术支持
 * Powered by elegant-admin
 * Github https://github.com/zhangyao1990/elegant-admin
 */

import{E as Ge}from"./eventemitter3-DvgLP6Ov.js";import{c as ce,E as I,L as ae,S as Y,a as X,M as K,B as q,N as ne,b as He,i as Ye,d as je,G as We,e as xe,g as Ke}from"./xgplayer-streaming-shared-CETjXEtL.js";import{T as Ee,W as te,F as Xe,a as Ce,b as Qe,M as re,L as ke}from"./xgplayer-transmuxer-CNksFnj3.js";import{B as we,S as ze,U as qe,D as Je,E as Ze,a as et}from"./xgplayer-BT1hwajv.js";function tt(l,a){var t=l==null?null:typeof Symbol<"u"&&l[Symbol.iterator]||l["@@iterator"];if(t!=null){var r,e,i,n,s=[],o=!0,u=!1;try{if(i=(t=t.call(l)).next,a===0){if(Object(t)!==t)return;o=!1}else for(;!(o=(r=i.call(t)).done)&&(s.push(r.value),s.length!==a);o=!0);}catch(h){u=!0,e=h}finally{try{if(!o&&t.return!=null&&(n=t.return(),Object(n)!==n))return}finally{if(u)throw e}}return s}}function Te(l,a){var t=Object.keys(l);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(l);a&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(l,e).enumerable})),t.push.apply(t,r)}return t}function O(l){for(var a=1;a<arguments.length;a++){var t=arguments[a]!=null?arguments[a]:{};a%2?Te(Object(t),!0).forEach(function(r){c(l,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(l,Object.getOwnPropertyDescriptors(t)):Te(Object(t)).forEach(function(r){Object.defineProperty(l,r,Object.getOwnPropertyDescriptor(t,r))})}return l}function E(){E=function(){return l};var l={},a=Object.prototype,t=a.hasOwnProperty,r=Object.defineProperty||function(v,S,_){v[S]=_.value},e=typeof Symbol=="function"?Symbol:{},i=e.iterator||"@@iterator",n=e.asyncIterator||"@@asyncIterator",s=e.toStringTag||"@@toStringTag";function o(v,S,_){return Object.defineProperty(v,S,{value:_,enumerable:!0,configurable:!0,writable:!0}),v[S]}try{o({},"")}catch{o=function(S,_,L){return S[_]=L}}function u(v,S,_,L){var w=S&&S.prototype instanceof p?S:p,N=Object.create(w.prototype),$=new R(L||[]);return r(N,"_invoke",{value:M(v,_,$)}),N}function h(v,S,_){try{return{type:"normal",arg:v.call(S,_)}}catch(L){return{type:"throw",arg:L}}}l.wrap=u;var d={};function p(){}function m(){}function f(){}var g={};o(g,i,function(){return this});var y=Object.getPrototypeOf,b=y&&y(y(B([])));b&&b!==a&&t.call(b,i)&&(g=b);var A=f.prototype=p.prototype=Object.create(g);function T(v){["next","throw","return"].forEach(function(S){o(v,S,function(_){return this._invoke(S,_)})})}function k(v,S){function _(w,N,$,W){var x=h(v[w],v,N);if(x.type!=="throw"){var ee=x.arg,ue=ee.value;return ue&&typeof ue=="object"&&t.call(ue,"__await")?S.resolve(ue.__await).then(function(J){_("next",J,$,W)},function(J){_("throw",J,$,W)}):S.resolve(ue).then(function(J){ee.value=J,$(ee)},function(J){return _("throw",J,$,W)})}W(x.arg)}var L;r(this,"_invoke",{value:function(w,N){function $(){return new S(function(W,x){_(w,N,W,x)})}return L=L?L.then($,$):$()}})}function M(v,S,_){var L="suspendedStart";return function(w,N){if(L==="executing")throw new Error("Generator is already running");if(L==="completed"){if(w==="throw")throw N;return Q()}for(_.method=w,_.arg=N;;){var $=_.delegate;if($){var W=U($,_);if(W){if(W===d)continue;return W}}if(_.method==="next")_.sent=_._sent=_.arg;else if(_.method==="throw"){if(L==="suspendedStart")throw L="completed",_.arg;_.dispatchException(_.arg)}else _.method==="return"&&_.abrupt("return",_.arg);L="executing";var x=h(v,S,_);if(x.type==="normal"){if(L=_.done?"completed":"suspendedYield",x.arg===d)continue;return{value:x.arg,done:_.done}}x.type==="throw"&&(L="completed",_.method="throw",_.arg=x.arg)}}}function U(v,S){var _=S.method,L=v.iterator[_];if(L===void 0)return S.delegate=null,_==="throw"&&v.iterator.return&&(S.method="return",S.arg=void 0,U(v,S),S.method==="throw")||_!=="return"&&(S.method="throw",S.arg=new TypeError("The iterator does not provide a '"+_+"' method")),d;var w=h(L,v.iterator,S.arg);if(w.type==="throw")return S.method="throw",S.arg=w.arg,S.delegate=null,d;var N=w.arg;return N?N.done?(S[v.resultName]=N.value,S.next=v.nextLoc,S.method!=="return"&&(S.method="next",S.arg=void 0),S.delegate=null,d):N:(S.method="throw",S.arg=new TypeError("iterator result is not an object"),S.delegate=null,d)}function G(v){var S={tryLoc:v[0]};1 in v&&(S.catchLoc=v[1]),2 in v&&(S.finallyLoc=v[2],S.afterLoc=v[3]),this.tryEntries.push(S)}function H(v){var S=v.completion||{};S.type="normal",delete S.arg,v.completion=S}function R(v){this.tryEntries=[{tryLoc:"root"}],v.forEach(G,this),this.reset(!0)}function B(v){if(v){var S=v[i];if(S)return S.call(v);if(typeof v.next=="function")return v;if(!isNaN(v.length)){var _=-1,L=function w(){for(;++_<v.length;)if(t.call(v,_))return w.value=v[_],w.done=!1,w;return w.value=void 0,w.done=!0,w};return L.next=L}}return{next:Q}}function Q(){return{value:void 0,done:!0}}return m.prototype=f,r(A,"constructor",{value:f,configurable:!0}),r(f,"constructor",{value:m,configurable:!0}),m.displayName=o(f,s,"GeneratorFunction"),l.isGeneratorFunction=function(v){var S=typeof v=="function"&&v.constructor;return!!S&&(S===m||(S.displayName||S.name)==="GeneratorFunction")},l.mark=function(v){return Object.setPrototypeOf?Object.setPrototypeOf(v,f):(v.__proto__=f,o(v,s,"GeneratorFunction")),v.prototype=Object.create(A),v},l.awrap=function(v){return{__await:v}},T(k.prototype),o(k.prototype,n,function(){return this}),l.AsyncIterator=k,l.async=function(v,S,_,L,w){w===void 0&&(w=Promise);var N=new k(u(v,S,_,L),w);return l.isGeneratorFunction(S)?N:N.next().then(function($){return $.done?$.value:N.next()})},T(A),o(A,s,"Generator"),o(A,i,function(){return this}),o(A,"toString",function(){return"[object Generator]"}),l.keys=function(v){var S=Object(v),_=[];for(var L in S)_.push(L);return _.reverse(),function w(){for(;_.length;){var N=_.pop();if(N in S)return w.value=N,w.done=!1,w}return w.done=!0,w}},l.values=B,R.prototype={constructor:R,reset:function(v){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(H),!v)for(var S in this)S.charAt(0)==="t"&&t.call(this,S)&&!isNaN(+S.slice(1))&&(this[S]=void 0)},stop:function(){this.done=!0;var v=this.tryEntries[0].completion;if(v.type==="throw")throw v.arg;return this.rval},dispatchException:function(v){if(this.done)throw v;var S=this;function _(x,ee){return N.type="throw",N.arg=v,S.next=x,ee&&(S.method="next",S.arg=void 0),!!ee}for(var L=this.tryEntries.length-1;L>=0;--L){var w=this.tryEntries[L],N=w.completion;if(w.tryLoc==="root")return _("end");if(w.tryLoc<=this.prev){var $=t.call(w,"catchLoc"),W=t.call(w,"finallyLoc");if($&&W){if(this.prev<w.catchLoc)return _(w.catchLoc,!0);if(this.prev<w.finallyLoc)return _(w.finallyLoc)}else if($){if(this.prev<w.catchLoc)return _(w.catchLoc,!0)}else{if(!W)throw new Error("try statement without catch or finally");if(this.prev<w.finallyLoc)return _(w.finallyLoc)}}}},abrupt:function(v,S){for(var _=this.tryEntries.length-1;_>=0;--_){var L=this.tryEntries[_];if(L.tryLoc<=this.prev&&t.call(L,"finallyLoc")&&this.prev<L.finallyLoc){var w=L;break}}w&&(v==="break"||v==="continue")&&w.tryLoc<=S&&S<=w.finallyLoc&&(w=null);var N=w?w.completion:{};return N.type=v,N.arg=S,w?(this.method="next",this.next=w.finallyLoc,d):this.complete(N)},complete:function(v,S){if(v.type==="throw")throw v.arg;return v.type==="break"||v.type==="continue"?this.next=v.arg:v.type==="return"?(this.rval=this.arg=v.arg,this.method="return",this.next="end"):v.type==="normal"&&S&&(this.next=S),d},finish:function(v){for(var S=this.tryEntries.length-1;S>=0;--S){var _=this.tryEntries[S];if(_.finallyLoc===v)return this.complete(_.completion,_.afterLoc),H(_),d}},catch:function(v){for(var S=this.tryEntries.length-1;S>=0;--S){var _=this.tryEntries[S];if(_.tryLoc===v){var L=_.completion;if(L.type==="throw"){var w=L.arg;H(_)}return w}}throw new Error("illegal catch attempt")},delegateYield:function(v,S,_){return this.delegate={iterator:B(v),resultName:S,nextLoc:_},this.method==="next"&&(this.arg=void 0),d}},l}function fe(l){"@babel/helpers - typeof";return fe=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},fe(l)}function Le(l,a,t,r,e,i,n){try{var s=l[i](n),o=s.value}catch(u){t(u);return}s.done?a(o):Promise.resolve(o).then(r,e)}function C(l){return function(){var a=this,t=arguments;return new Promise(function(r,e){var i=l.apply(a,t);function n(o){Le(i,r,e,n,s,"next",o)}function s(o){Le(i,r,e,n,s,"throw",o)}n(void 0)})}}function V(l,a){if(!(l instanceof a))throw new TypeError("Cannot call a class as a function")}function Ae(l,a){for(var t=0;t<a.length;t++){var r=a[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(l,Ne(r.key),r)}}function F(l,a,t){return a&&Ae(l.prototype,a),t&&Ae(l,t),Object.defineProperty(l,"prototype",{writable:!1}),l}function c(l,a,t){return a=Ne(a),a in l?Object.defineProperty(l,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):l[a]=t,l}function me(l,a){if(typeof a!="function"&&a!==null)throw new TypeError("Super expression must either be null or a function");l.prototype=Object.create(a&&a.prototype,{constructor:{value:l,writable:!0,configurable:!0}}),Object.defineProperty(l,"prototype",{writable:!1}),a&&ye(l,a)}function de(l){return de=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},de(l)}function ye(l,a){return ye=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,e){return r.__proto__=e,r},ye(l,a)}function rt(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function it(l,a){if(l==null)return{};var t={},r=Object.keys(l),e,i;for(i=0;i<r.length;i++)e=r[i],!(a.indexOf(e)>=0)&&(t[e]=l[e]);return t}function De(l,a){if(l==null)return{};var t=it(l,a),r,e;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(l);for(e=0;e<i.length;e++)r=i[e],!(a.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(l,r)&&(t[r]=l[r])}return t}function D(l){if(l===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return l}function nt(l,a){if(a&&(typeof a=="object"||typeof a=="function"))return a;if(a!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return D(l)}function ve(l){var a=rt();return function(){var r=de(l),e;if(a){var i=de(this).constructor;e=Reflect.construct(r,arguments,i)}else e=r.apply(this,arguments);return nt(this,e)}}function z(l,a){return ut(l)||tt(l,a)||Me(l,a)||ht()}function at(l){return st(l)||ot(l)||Me(l)||lt()}function st(l){if(Array.isArray(l))return _e(l)}function ut(l){if(Array.isArray(l))return l}function ot(l){if(typeof Symbol<"u"&&l[Symbol.iterator]!=null||l["@@iterator"]!=null)return Array.from(l)}function Me(l,a){if(l){if(typeof l=="string")return _e(l,a);var t=Object.prototype.toString.call(l).slice(8,-1);if(t==="Object"&&l.constructor&&(t=l.constructor.name),t==="Map"||t==="Set")return Array.from(l);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return _e(l,a)}}function _e(l,a){(a==null||a>l.length)&&(a=l.length);for(var t=0,r=new Array(a);t<a;t++)r[t]=l[t];return r}function lt(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function ht(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function ct(l,a){if(typeof l!="object"||l===null)return l;var t=l[Symbol.toPrimitive];if(t!==void 0){var r=t.call(l,a||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(l)}function Ne(l){var a=ct(l,"string");return typeof a=="symbol"?a:String(a)}var ft=function(){function l(){V(this,l);var a=window.crypto||window.msCrypto;this.subtle=a&&(a.subtle||a.webkitSubtle),this.externalDecryptor=null}return F(l,[{key:"destroy",value:function(){var t;(t=this.externalDecryptor)!==null&&t!==void 0&&t.destroy&&this.externalDecryptor.destroy()}},{key:"decrypt",value:function(t,r){if(!(!t&&!r)){var e=[];return t&&(e[0]=this._decryptSegment(t)),r&&(e[1]=this._decryptSegment(r)),Promise.all(e)}}},{key:"_decryptSegment",value:function(){var a=C(E().mark(function r(e){var i;return E().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(i=e.data,!e.key){s.next=5;break}return s.next=4,this._decryptData(e.data,e.key,e.keyIv);case 4:i=s.sent;case 5:if(e.map){s.next=7;break}return s.abrupt("return",i);case 7:return s.abrupt("return",ce(e.map,i));case 8:case"end":return s.stop()}},r,this)}));function t(r){return a.apply(this,arguments)}return t}()},{key:"_decryptData",value:function(){var a=C(E().mark(function r(e,i,n){var s;return E().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:if(!this.externalDecryptor){u.next=6;break}return u.next=3,this.externalDecryptor.decrypt(e,i,n);case 3:return u.abrupt("return",u.sent);case 6:if(this.subtle){u.next=8;break}throw new Error("crypto is not defined");case 8:return u.next=10,this.subtle.importKey("raw",i,{name:"AES-CBC"},!1,["encrypt","decrypt"]);case 10:return s=u.sent,u.t0=Uint8Array,u.next=14,this.subtle.decrypt({name:"AES-CBC",iv:n},s,e);case 14:return u.t1=u.sent,u.abrupt("return",new u.t0(u.t1));case 16:case"end":return u.stop()}},r,this)}));function t(r,e,i){return a.apply(this,arguments)}return t}()}]),l}(),P=O(O({},I),{},{STREAM_PARSED:"core.streamparsed",NO_AUDIO_TRACK:"core.noaudiotrack",SUBTITLE_SEGMENTS:"core.subtitlesegments",SUBTITLE_PLAYLIST:"core.subtitleplaylist",SEI_PAYLOAD_TIME:"core.seipayloadtime",APPEND_COST:"core.appendcost"}),pe=new ae("Transmuxer"),Ie=function(){function l(a,t,r){V(this,l),c(this,"_initSegmentId",""),this.hls=a,this._demuxer=t?new Xe:new Ce,this._isMP4=t,r&&(this._remuxer=new Qe(this._demuxer.videoTrack,this._demuxer.audioTrack))}return F(l,[{key:"transmux",value:function(t,r,e,i,n,s){var o=this._demuxer;try{this._isMP4?o.demux(t,r):o.demuxAndFix(ce(t,r),e,i,n)}catch(U){throw new Y(X.DEMUX,X.SUB_TYPES.HLS,U)}var u=o.videoTrack,h=o.audioTrack,d=o.metadataTrack,p={codec:u.codec,timescale:u.timescale,firstDts:u.firstDts/u.timescale,firstPts:u.firstPts/u.timescale,duration:u.samplesDuration/u.timescale},m={codec:h.codec,timescale:h.timescale,firstDts:h.firstDts/u.timescale,firstPts:h.firstPts/u.timescale,duration:h.samplesDuration/u.timescale},f="".concat(u.codec,"/").concat(u.width,"/").concat(u.height,"/").concat(h.codec,"/").concat(h.config);if(f!==this._initSegmentId&&(this._initSegmentId=f,s=!0),this._fireEvents(u,h,d,e||s),this.hls.emit(P.DEMUXED_TRACK,{videoTrack:u,audioTrack:h}),this._remuxer){s&&this.hls.isLive&&!this.hls.config.mseLowLatency&&(u.duration=this.hls.totalDuration*u.timescale,h.duration=this.hls.totalDuration*h.timescale);try{var g=this._remuxer.remux(s),y=g.videoInitSegment,b=g.videoSegment,A=g.audioInitSegment,T=g.audioSegment,k=ce(y,b),M=ce(A,T);return[k?O(O({},p),{},{data:k}):void 0,M?O(O({},m),{},{data:M}):void 0]}catch(U){throw new Y(X.REMUX,X.SUB_TYPES.FMP4,U)}}else return[u,h]}},{key:"_fireEvents",value:function(t,r,e,i){var n=this,s=[t,r],o="discontinuity: ".concat(i);s.forEach(function(u){var h;(h=u.samples)!==null&&h!==void 0&&h.length&&(o+="; ".concat(u.samples.length," ").concat(u.type===Ee.VIDEO?"video":"audio"," samples, firstDts/firstPts/duration: ").concat((u.firstDts/u.timescale).toFixed(3),"/").concat((u.firstPts/u.timescale).toFixed(3),"/").concat((u.samplesDuration/u.timescale).toFixed(3))),i&&u.exist()&&n.hls.emit(P.METADATA_PARSED,{type:u.type,track:u,meta:O({codec:u.codec,timescale:u.timescale,baseDts:u.baseDts},u.type===Ee.VIDEO?{width:u.width,height:u.height,sarRatio:u.sarRatio}:{codec:u.codec,channelCount:u.channelCount,sampleRate:u.sampleRate})})}),pe.debug(o),t.warnings.forEach(function(u){var h;switch(u.type){case te.LARGE_AV_SHIFT:h=P.LARGE_AV_FIRST_FRAME_GAP_DETECT;break;case te.LARGE_VIDEO_GAP:h=P.LARGE_VIDEO_DTS_GAP_DETECT;break;case te.LARGE_VIDEO_GAP_BETWEEN_CHUNK:h=P.MAX_DTS_DELTA_WITH_NEXT_SEGMENT_DETECT;break}h&&n.hls.emit(P.STREAM_EXCEPTION,O(O({},u),{},{type:h})),pe.warn("video exception",u)}),r.warnings.forEach(function(u){var h;switch(u.type){case te.LARGE_AUDIO_GAP:h=P.LARGE_AUDIO_DTS_GAP_DETECT;break;case te.AUDIO_FILLED:h=P.AUDIO_GAP_DETECT;break;case te.AUDIO_DROPPED:h=P.AUDIO_OVERLAP_DETECT;break}h&&n.hls.emit(P.STREAM_EXCEPTION,O(O({},u),{},{type:h})),pe.warn("audio exception",u)}),t.samples.forEach(function(u){u.keyframe&&n.hls.emit(P.KEYFRAME,{pts:u.pts})}),e.seiSamples.forEach(function(u){n.hls.emit(P.SEI,O(O({},u),{},{originPts:u.originPts/90,sei:{code:u.data.type,content:u.data.payload,dts:u.pts}}))})}}]),l}(),dt=["data"],mt=["data"],Pe=new ae("BufferService"),vt=function(){function l(a){var t=this;V(this,l),c(this,"_decryptor",new ft),c(this,"_transmuxer",null),c(this,"_mse",null),c(this,"_softVideo",null),c(this,"_sourceCreated",!1),c(this,"_needInitSegment",!0),c(this,"_directAppend",!1),this.hls=a,a.config.softDecode?this._softVideo=a.media:(this._mse=new K(null,{preferMMS:a.config.preferMMS}),a.config.url&&this._mse.bindMedia(a.media).then(function(r){t.hls.emit(I.MEDIASOURCE_OPENED,r)})),a.config.decryptor&&(this._decryptor.externalDecryptor=a.config.decryptor)}return F(l,[{key:"baseDts",get:function(){var t,r,e;return(t=this._transmuxer)===null||t===void 0||(r=t._demuxer)===null||r===void 0||(e=r._fixer)===null||e===void 0?void 0:e._baseDts}},{key:"nbSb",get:function(){var t;return(t=this._mse)!==null&&t!==void 0&&t._sourceBuffer?Object.keys(this._mse._sourceBuffer).length:0}},{key:"msIsOpened",get:function(){var t;return(t=this._mse)===null||t===void 0?void 0:t.isOpened}},{key:"msHasOpTasks",get:function(){var t;return(t=this._mse)===null||t===void 0?void 0:t.hasOpTasks}},{key:"msStreaming",get:function(){var t;return(t=this._mse)===null||t===void 0?void 0:t.streaming}},{key:"updateDuration",value:function(){var a=C(E().mark(function r(e){return E().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(Pe.debug("update duration",e),!this._mse){n.next=9;break}if(this._mse.isOpened){n.next=5;break}return n.next=5,this._mse.open();case 5:return n.next=7,this._mse.updateDuration(e);case 7:n.next=10;break;case 9:this._softVideo&&(this._softVideo.duration=e);case 10:case"end":return n.stop()}},r,this)}));function t(r){return a.apply(this,arguments)}return t}()},{key:"createSource",value:function(t,r,e,i){if(!this._sourceCreated){var n=t||r;if(n){if(Ce.probe(n))this._transmuxer||(this._transmuxer=new Ie(this.hls,!1,!this._softVideo));else if(re.probe(n))if(this._softVideo)this._transmuxer||(this._transmuxer=new Ie(this.hls,!0));else{this._directAppend=!0;var s=!1;t&&!e&&re.findBox(t,["moov","trak"]).forEach(function(o){var u=re.findBox(o.data,["trak","mdia","minf","stbl","stsd"])[0];if(u){var h=re.stsd(u).entries[0];if(h){if(h.hvcC)e=h.hvcC.codec||"hev1.1.6.L93.B0";else if(h.avcC)e=h.avcC.codec;else if(h.sampleRate||h.esds){var d;i=((d=h.esds)===null||d===void 0?void 0:d.codec)||"mp4a.40.2",s=!0}}}}),r&&!i&&re.findBox(r,["moov","trak","mdia","minf","stbl","stsd"]).forEach(function(o){var u=re.stsd(o).entries[0];u&&u.esds&&(i=u.esds.codec)}),t&&!e&&(e="avc1.42e01e"),r&&!i&&(i="mp4a.40.2"),s&&(e+=", ".concat(i),i=""),this._createMseSource(e,i)}else throw new Y(X.OTHER,null,null,null,"unsupported stream");this._softVideo&&(this._sourceCreated=!0)}}}},{key:"appendBuffer",value:function(){var a=C(E().mark(function r(e,i,n,s,o,u,h){var d,p,m,f,g,y,b,A,T,k,M,U,G;return E().wrap(function(R){for(;;)switch(R.prev=R.next){case 0:if(!(!(n!=null&&n.length)&&!(s!=null&&s.length))){R.next=2;break}return R.abrupt("return");case 2:if(!this._directAppend){R.next=7;break}return d=[],n&&d.push(this._mse.append(K.VIDEO,n)),s&&d.push(this._mse.append(K.AUDIO,s)),R.abrupt("return",Promise.all(d));case 7:if(p=this._needInitSegment||o,m=this._transmuxer.transmux(n,s,p,u,h,this._needInitSegment||o),f=z(m,2),g=f[0],y=f[1],s&&i&&(i==null||i.setTrackExist(!1,!0)),s&&e&&(e==null||e.setTrackExist(!0,!1)),i||e==null||e.setTrackExist(!!g,!!y),g&&!y&&this.hls.emit(P.NO_AUDIO_TRACK),!this._softVideo){R.next=18;break}this._softVideo.appendBuffer(g,y),this._needInitSegment=!1,R.next=28;break;case 18:if(!this._mse){R.next=28;break}return b=!this._sourceCreated,b&&this._createMseSource(g==null?void 0:g.codec,y==null?void 0:y.codec),this._needInitSegment=!1,A=this._mse,T=[],p&&!b&&this._handleCodecChange(g,y).forEach(function(B){return T.push(B)}),g&&(k=g.data,M=De(g,dt),T.push(A.append(K.VIDEO,k,M))),y&&(U=y.data,G=De(y,mt),T.push(A.append(K.AUDIO,U,G))),R.abrupt("return",Promise.all(T));case 28:case"end":return R.stop()}},r,this)}));function t(r,e,i,n,s,o,u){return a.apply(this,arguments)}return t}()},{key:"removeBuffer",value:function(){var a=C(E().mark(function r(){var e=this,i,n,s,o=arguments;return E().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(i=o.length>0&&o[0]!==void 0?o[0]:0,n=o.length>1&&o[1]!==void 0?o[1]:1/0,s=this.hls.media,!(!this._mse||!s||i<0||n<i||i>=this._mse.duration)){h.next=5;break}return h.abrupt("return");case 5:return h.abrupt("return",this._mse.clearBuffer(i,n).then(function(){return e.hls.emit(I.REMOVE_BUFFER,{start:i,end:n,removeEnd:n})}));case 6:case"end":return h.stop()}},r,this)}));function t(){return a.apply(this,arguments)}return t}()},{key:"evictBuffer",value:function(){var a=C(E().mark(function r(e){var i,n,s,o;return E().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(i=this.hls.media,!(!this._mse||!i||!e||e<0)){h.next=3;break}return h.abrupt("return");case 3:if(n=i.currentTime,s=n-e,!(s<=0)){h.next=7;break}return h.abrupt("return");case 7:if(o=q.start(q.get(i)),!(o+1>=s)){h.next=10;break}return h.abrupt("return");case 10:return h.abrupt("return",this.removeBuffer(0,s));case 11:case"end":return h.stop()}},r,this)}));function t(r){return a.apply(this,arguments)}return t}()},{key:"clearAllBuffer",value:function(){var a=C(E().mark(function r(){return E().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=2;break}return i.abrupt("return",this._mse.clearAllBuffer());case 2:case"end":return i.stop()}},r,this)}));function t(){return a.apply(this,arguments)}return t}()},{key:"decryptBuffer",value:function(t,r){return this._decryptor.decrypt(t,r)}},{key:"reset",value:function(){var a=C(E().mark(function r(){var e,i=arguments;return E().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(e=i.length>0&&i[0]!==void 0?i[0]:!1,!(this._mse&&!e)){s.next=8;break}return this._transmuxer=null,this._sourceCreated=!1,s.next=6,this._mse.unbindMedia();case 6:return s.next=8,this._mse.bindMedia(this.hls.media);case 8:this._needInitSegment=!0,this._directAppend=!1;case 10:case"end":return s.stop()}},r,this)}));function t(){return a.apply(this,arguments)}return t}()},{key:"endOfStream",value:function(){var a=C(E().mark(function r(){return E().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=5;break}if(!this._sourceCreated){i.next=5;break}return i.next=4,this._mse.endOfStream();case 4:this.hls.emit(I.BUFFEREOS);case 5:this._softVideo&&this._softVideo.endOfStream();case 6:case"end":return i.stop()}},r,this)}));function t(){return a.apply(this,arguments)}return t}()},{key:"setLiveSeekableRange",value:function(){var a=C(E().mark(function r(e,i){return E().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:this._mse&&this._mse.setLiveSeekableRange(e,i);case 1:case"end":return s.stop()}},r,this)}));function t(r,e){return a.apply(this,arguments)}return t}()},{key:"destroy",value:function(){var a=C(E().mark(function r(){var e;return E().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if((e=this._decryptor)===null||e===void 0||e.destroy(),!this._mse){n.next=4;break}return n.next=4,this._mse.unbindMedia();case 4:this._decryptor=null,this._mse=null,this._softVideo=null;case 7:case"end":return n.stop()}},r,this)}));function t(){return a.apply(this,arguments)}return t}()},{key:"_createMseSource",value:function(t,r){Pe.debug("create mse source, videoCodec=".concat(t,", audioCodec=").concat(r));var e=this._mse;e&&(t&&(e.createSource(K.VIDEO,"video/mp4;codecs=".concat(t)),this._sourceCreated=!0),r&&(e.createSource(K.AUDIO,"audio/mp4;codecs=".concat(r)),this._sourceCreated=!0),this.hls.emit(I.SOURCEBUFFER_CREATED))}},{key:"_handleCodecChange",value:function(t,r){var e=[],i=this._mse,n=[{type:K.VIDEO,codecs:t==null?void 0:t.codec},{type:K.AUDIO,codecs:r==null?void 0:r.codec}];return n.filter(function(s){return!!s.codecs}).forEach(function(s){var o=s.type,u=s.codecs,h=i.getSourceBuffer(o);if(h){var d=u.split(",")[0];new RegExp(d,"ig").test(h.mimeType)||e.push(i.changeType(o,"".concat(o,"/mp4;codecs=").concat(u)))}}),e}},{key:"seamlessSwitch",value:function(){this._needInitSegment=!0}},{key:"isFull",value:function(){var t,r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:K.VIDEO;return(t=this._mse)===null||t===void 0?void 0:t.isFull(r)}}]),l}();function pt(l){var a=(l==null?void 0:l.media)||document.createElement("video");return O(O({maxPlaylistSize:50,retryCount:3,retryDelay:1e3,pollRetryCount:2,loadTimeout:1e4,manifestLoadTimeout:1e4,preloadTime:30,softDecode:!1,bufferBehind:10,maxJumpDistance:3,startTime:0,useLowLatency:!0,targetLatency:10,maxLatency:20,allowedStreamTrackChange:!0,seiInTime:!1,manifestList:[],minSegmentsStartPlay:3,preferMMS:!1,preferMMSStreaming:!1,mseLowLatency:!0},l),{},{media:a})}var gt=F(function l(){V(this,l),c(this,"version",0),c(this,"streams",[]),c(this,"isMaster",!0)}),Be={Audio:"AUDIO",Video:"VIDEO",SubTitle:"SUBTITLE",ClosedCaptions:"CLOSED-CAPTIONS"},oe={CLEAR_KEY:"org.w3.clearkey",FAIRPLAY:["urn:uuid:94ce86fb-07ff-4f43-adb8-93d2fa968ca2","com.apple.streamingkeydelivery"],WIDEVINE:["urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine.alpha","com.widevine"],PLAYREADY:["urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95","com.microsoft.playready"]};function Ue(l){for(var a=[],t=0;t<l.length;t++)Array.isArray(l[t])?a=a.concat(Ue(l[t])):a.push(l[t]);return a}var be=F(function l(){V(this,l),c(this,"id",0),c(this,"url",""),c(this,"default",!1),c(this,"autoSelect",!1),c(this,"forced",!1),c(this,"group",""),c(this,"name",""),c(this,"lang",""),c(this,"segments",[]),c(this,"endSN",0)}),St=function(l){me(t,l);var a=ve(t);function t(){var r;V(this,t);for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return r=a.call.apply(a,[this].concat(i)),c(D(r),"mediaType",Be.Audio),c(D(r),"channels",0),r}return F(t)}(be),yt=function(l){me(t,l);var a=ve(t);function t(){var r;V(this,t);for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return r=a.call.apply(a,[this].concat(i)),c(D(r),"mediaType",Be.SubTitle),r}return F(t)}(be),_t=F(function l(){V(this,l),c(this,"id",0),c(this,"bitrate",0),c(this,"width",0),c(this,"height",0),c(this,"name",""),c(this,"url",""),c(this,"audioCodec",""),c(this,"videoCodec",""),c(this,"textCodec",""),c(this,"audioGroup",""),c(this,"audioStreams",[]),c(this,"subtitleStreams",[]),c(this,"closedCaptionsStream",[])}),bt=F(function l(){V(this,l),c(this,"version",0),c(this,"url",""),c(this,"type",""),c(this,"startCC",0),c(this,"endCC",0),c(this,"startSN",0),c(this,"endSN",0),c(this,"totalDuration",0),c(this,"targetDuration",0),c(this,"partTargetDuration",0),c(this,"canSkipUntil",0),c(this,"canSkipDateRanges",!1),c(this,"skippedSegments",0),c(this,"canBlockReload",!1),c(this,"partHoldBack",0),c(this,"live",!0),c(this,"lowLatency",!1),c(this,"endPartIndex",0),c(this,"segments",[])}),le=function(){function l(a){V(this,l),c(this,"sn",0),c(this,"cc",0),c(this,"url",""),c(this,"parentUrl",""),c(this,"title",""),c(this,"start",0),c(this,"duration",0),c(this,"dataTime",""),c(this,"key",null),c(this,"byteRange",null),c(this,"isInitSegment",!1),c(this,"initSegment",null),c(this,"isLast",!1),c(this,"hasAudio",!1),c(this,"hasVideo",!1),c(this,"independent",!1),c(this,"partIndex",0),this.parentUrl=a}return F(l,[{key:"end",get:function(){return this.start+this.duration}},{key:"setTrackExist",value:function(t,r){this.hasVideo=t,this.hasAudio=r}},{key:"setByteRange",value:function(t,r){this.byteRange=[0];var e=t.split("@");e.length===1&&r&&r.byteRange?(this.byteRange[0]=r.byteRange[1]||0,this.byteRange[0]&&(this.byteRange[0]+=1)):this.byteRange[0]=parseInt(e[1]),this.byteRange[1]=this.byteRange[0]+parseInt(e[0])-1}}]),l}(),Et=function(){function l(a){V(this,l),c(this,"method",""),c(this,"url",""),c(this,"iv",null),c(this,"keyFormat",""),c(this,"keyFormatVersions",""),a instanceof l&&(this.method=a.method,this.url=a.url,this.keyFormat=a.keyFormat,this.keyFormatVersions=a.keyFormatVersions,a.iv&&(this.iv=new Uint8Array(a.iv)))}return F(l,[{key:"clone",value:function(t){var r=new l(this);return t!=null&&r.setIVFromSN(t),r}},{key:"setIVFromSN",value:function(t){if(!this.iv&&this.method==="AES-128"&&typeof t=="number"&&this.url){this.iv=new Uint8Array(16);for(var r=12;r<16;r++)this.iv[r]=t>>8*(15-r)&255}}},{key:"isSegmentEncrypted",value:function(){var t=this.method;return t==="AES-128"}},{key:"isValidKeySystem",value:function(){var t=Ue([oe.CLEAR_KEY,oe.FAIRPLAY,oe.WIDEVINE,oe.PLAYREADY]).indexOf(this.keyFormat)>-1;if(!t)return!1;var r=["SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)>-1;return!!r}},{key:"isSupported",value:function(){return this.method?this.isSegmentEncrypted()?!0:!!this.isValidKeySystem():!1}}]),l}(),kt=/^#(EXT[^:]*)(?::(.*))?$/,Oe=/([^=]+)=(?:"([^"]*)"|([^",]*))(?:,|$)/g,wt=/^(?:[a-zA-Z0-9+\-.]+:)?\/\//,Tt=/^((?:[a-zA-Z0-9+\-.]+:)?\/\/[^/?#]*)?([^?#]*\/)?/;function Lt(l){return l.split(/[\r\n]/).map(function(a){return a.trim()}).filter(Boolean)}function $e(l){var a=l.match(kt);if(!(!a||!a[1]))return[a[1].replace("EXT-X-",""),a[2]]}function Z(l){for(var a={},t=Oe.exec(l);t;)a[t[1]]=t[2]||t[3],t=Oe.exec(l);return a}function ie(l,a){if(!a||!l||wt.test(l))return l;var t=Tt.exec(a);return t?l[0]==="/"?t[1]+l:t[1]+t[2]+l:l}var At={audio:[/^mp4a/,/^vorbis$/,/^opus$/,/^flac$/,/^[ae]c-3$/],video:[/^avc/,/^hev/,/^hvc/,/^vp0?[89]/,/^av1$/],text:[/^vtt$/,/^wvtt/,/^stpp/]};function ge(l,a){var t=At[l];if(!(!t||!a||!a.length)){for(var r=0;r<t.length;r++)for(var e=0;e<a.length;e++)if(t[r].test(a[e]))return a[e]}}function Dt(l,a){for(var t=new gt,r=0,e,i=[],n=[];e=l[r++];){var s=$e(e);if(s){var o=z(s,2),u=o[0],h=o[1];if(u==="VERSION")t.version=parseInt(h);else if(u==="MEDIA"&&h){var d=Z(h),p=void 0;switch(d.TYPE){case"AUDIO":p=new St;break;case"SUBTITLES":p=new yt;break;default:p=new be}p.url=ie(d.URI,a),p.default=d.DEFAULT==="YES",p.autoSelect=d.AUTOSELECT==="YES",p.group=d["GROUP-ID"],p.name=d.NAME,p.lang=d.LANGUAGE,d.CHANNELS&&(p.channels=Number(d.CHANNELS.split("/")[0]),Number.isNaN(p.channels)&&(p.channels=0)),d.TYPE==="AUDIO"&&d.URI&&i.push(p),d.TYPE==="SUBTITLES"&&n.push(p)}else if(u==="STREAM-INF"&&h){var m=new _t,f=Z(h);if(m.bitrate=parseInt(f["AVERAGE-BANDWIDTH"]||f.BANDWIDTH),m.name=f.NAME,m.url=ie(l[r++],a),f.RESOLUTION){var g=f.RESOLUTION.split("x"),y=z(g,2),b=y[0],A=y[1];m.width=parseInt(b),m.height=parseInt(A)}if(f.CODECS){var T=f.CODECS.split(/[ ,]+/).filter(Boolean);m.videoCodec=ge("video",T),m.audioCodec=ge("audio",T),m.textCodec=ge("text",T)}m.audioGroup=f.AUDIO,m.subtitleGroup=f.SUBTITLES,t.streams.push(m)}}}return t.streams.forEach(function(k,M){k.id=M}),i.length&&(i.forEach(function(k,M){k.id=M}),t.streams.forEach(function(k){k.audioGroup&&(k.audioStreams=i.filter(function(M){return M.group===k.audioGroup}))})),n.length&&(n.forEach(function(k,M){k.id=M}),t.streams.forEach(function(k){k.subtitleGroup&&(k.subtitleStreams=n.filter(function(M){return M.group===k.subtitleGroup}))})),t}function It(l,a,t){var r=new bt;r.url=a;for(var e=new le(a),i=null,n=null,s=0,o=0,u=0,h=0,d,p=!1,m=0;(d=l[h++])&&!p;){if(d[0]!=="#"){if(r.lowLatency){o++;continue}e.sn=o,e.cc=u,e.url=ie(d,a),n&&(e.key=n.clone(o)),i&&(e.initSegment=i),r.segments.push(e),e=new le(a),o++;continue}var f=$e(d);if(f){var g=z(f,2),y=g[0],b=g[1];switch(y){case"VERSION":r.version=parseInt(b);break;case"PLAYLIST-TYPE":r.type=b==null?void 0:b.toUpperCase();break;case"TARGETDURATION":r.targetDuration=parseFloat(b);break;case"PART-INF":{t&&(r.lowLatency=!0);var A=Z(b);A["PART-TARGET"]&&(r.partTargetDuration=parseFloat(A["PART-TARGET"]))}break;case"SERVER-CONTROL":{var T=Z(b);r.canBlockReload=T["CAN-BLOCK-RELOAD"]==="YES",r.partHoldBack=parseFloat(T["PART-HOLD-BACK"]||0),r.canSkipUntil=parseFloat(T["CAN-SKIP-UNTIL"]||0),r.canSkipDateRanges=T["CAN-SKIP-DATERANGES"]==="YES"}break;case"ENDLIST":{var k=r.segments[r.segments.length-1];k&&(k.isLast=!0),r.live=!1,p=!0}break;case"MEDIA-SEQUENCE":o=r.startSN=parseInt(b);break;case"DISCONTINUITY-SEQUENCE":u=r.startCC=parseInt(b);break;case"DISCONTINUITY":u++;break;case"BYTERANGE":e.setByteRange(b,r.segments[r.segments.length-1]);break;case"PART":{if(!r.lowLatency)break;var M=Z(b);e.duration=parseFloat(M.DURATION),e.independent=M.INDEPENDENT==="YES",e.sn=o,e.cc=u,e.partIndex=m,e.start=s,e.duration=parseFloat(M.DURATION),s+=e.duration,e.url=ie(M.URI,a),n&&(e.key=n.clone(o)),i&&(e.initSegment=i),r.segments.push(e),e=new le(a),m++}break;case"PRELOAD-HINT":break;case"PROGRAM-DATE-TIME":e.dataTime=b;break;case"EXTINF":{if(r.lowLatency){m=0;break}var U=b.split(","),G=z(U,2),H=G[0],R=G[1];e.start=s,e.duration=parseFloat(H),s+=e.duration,e.title=R}break;case"KEY":{var B=Z(b);if(B.METHOD==="NONE"){n=null;break}if(n=new Et,n.method=B.METHOD,n.url=/^blob:/.test(B.URI)?B.URI:ie(B.URI,a),n.keyFormat=B.KEYFORMAT||"identity",n.keyFormatVersions=B.KEYFORMATVERSIONS,!n.isSupported())throw new Error("encrypt ".concat(B.METHOD,"/").concat(B.KEYFORMAT," is not supported"));if(B.IV){var Q=B.IV.slice(2);Q=(Q.length&1?"0":"")+Q,n.iv=new Uint8Array(Q.length/2);for(var v=0,S=Q.length/2;v<S;v++)n.iv[v]=parseInt(Q.slice(v*2,v*2+2),16)}}break;case"MAP":{var _=Z(b);e.url=ie(_.URI,a),_.BYTERANGE&&e.setByteRange(_.BYTERANGE),e.isInitSegment=!0,e.sn=0,n&&(e.key=n.clone(0)),i=e,e=new le(a)}break}}}r.segments=r.segments.filter(function(w){return w.duration!==0});var L=r.segments[r.segments.length-1];return L&&(r.endSN=L.sn,r.endPartIndex=L.partIndex,p&&!L.isLast&&(L.isLast=!0)),r.totalDuration=s,r.endCC=u,r}var he=function(){function l(){V(this,l)}return F(l,null,[{key:"parse",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",r=arguments.length>1?arguments[1]:void 0,e=arguments.length>2?arguments[2]:void 0;if(!t.includes("#EXTM3U"))throw new Error("Invalid m3u8 file");var i=Lt(t);return l.isMediaPlaylist(t)?It(i,r,e):Dt(i,r)}},{key:"isMediaPlaylist",value:function(t){return t.includes("#EXTINF:")||t.includes("#EXT-X-TARGETDURATION:")}}]),l}(),Pt=function(){function l(a){var t=this;V(this,l),c(this,"_emitOnLoaded",function(o,u){var h=o.response,d=o.options,p=d||{},m=p.firstByteTime,f=p.startTime,g=p.endTime,y=p.contentLength,b=g-f;t.hls.emit(I.SPEED,{time:b,byteLength:y,url:u}),t.hls.emit(I.LOAD_COMPLETE,{url:u,elapsed:b||0}),t.hls.emit(I.TTFB,{url:u,responseUrl:h.url,elapsed:m-f}),t.hls.emit(I.LOAD_RESPONSE_HEADERS,{headers:h.headers,url:u})}),c(this,"_onLoaderRetry",function(o,u){t.hls.emit(P.LOAD_RETRY,{error:Y.network(o),retryTime:u})}),this.hls=a,this._timer=null,this._useLowLatency=a.config.useLowLatency;var r=this.hls.config,e=r.retryCount,i=r.retryDelay,n=r.manifestLoadTimeout,s=r.fetchOptions;this._loader=new ne(O(O({},s),{},{responseType:"text",retry:e,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry})),this._audioLoader=new ne(O(O({},s),{},{responseType:"text",retry:e,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry})),this._subtitleLoader=new ne(O(O({},s),{},{responseType:"text",retry:e,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry}))}return F(l,[{key:"load",value:function(){var a=C(E().mark(function r(e,i,n){var s,o,u,h,d,p,m,f,g,y,b,A,T,k,M,U,G,H,R,B;return E().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:return s=[this._loader.load(e)],i&&s.push(this._audioLoader.load(i)),n&&s.push(this._subtitleLoader.load(n)),v.prev=3,v.next=6,Promise.all(s);case 6:if(f=v.sent,g=z(f,3),y=g[0],b=g[1],A=g[2],y){v.next=13;break}return v.abrupt("return",[]);case 13:this._emitOnLoaded(y,e),o=y.data,d=y.response.url||e,i?(u=b==null?void 0:b.data,h=A==null?void 0:A.data,p=(b==null||(T=b.response)===null||T===void 0?void 0:T.url)||i,m=(A==null||(k=A.response)===null||k===void 0?void 0:k.url)||n,u&&this._emitOnLoaded(b,i),h&&this._emitOnLoaded(A,n)):(h=b==null?void 0:b.data,m=(b==null||(M=b.response)===null||M===void 0?void 0:M.url)||n,h&&this._emitOnLoaded(b,n)),v.next=22;break;case 19:throw v.prev=19,v.t0=v.catch(3),Y.network(v.t0);case 22:if(U=this.hls.config.onPreM3U8Parse,v.prev=23,U&&(o=U(o)||o,u&&(u=U(u,!0)||u),h&&(h=U(h,!0)||h)),G=he.parse(o,d,this._useLowLatency),!(((B=G)===null||B===void 0?void 0:B.live)===!1&&G.segments&&!G.segments.length)){v.next=28;break}throw new Error("empty segments list");case 28:u&&(H=he.parse(u,p,this._useLowLatency)),h&&(R=he.parse(h,m,this._useLowLatency)),v.next=35;break;case 32:throw v.prev=32,v.t1=v.catch(23),new Y(X.MANIFEST,X.SUB_TYPES.HLS,v.t1);case 35:return G&&(G.isMaster?this.hls.emit(P.HLS_MANIFEST_LOADED,{playlist:G}):this.hls.emit(P.HLS_LEVEL_LOADED,{playlist:G})),v.abrupt("return",[G,H,R]);case 37:case"end":return v.stop()}},r,this,[[3,19],[23,32]])}));function t(r,e,i){return a.apply(this,arguments)}return t}()},{key:"parseText",value:function(t,r){var e=this.hls.config.onPreM3U8Parse,i;try{var n;if(e&&(t=e(t)||t),i=he.parse(t,r,this._useLowLatency),((n=i)===null||n===void 0?void 0:n.live)===!1&&i.segments&&!i.segments.length)throw new Error("empty segments list")}catch(s){throw new Y(X.MANIFEST,X.SUB_TYPES.HLS,s)}return i&&(i.isMaster?this.hls.emit(P.HLS_MANIFEST_LOADED,{playlist:i}):this.hls.emit(P.HLS_LEVEL_LOADED,{playlist:i})),[i]}},{key:"poll",value:function(t,r,e,i,n,s){var o=this;clearTimeout(this._timer),s=s||3e3;var u=this.hls.config.pollRetryCount,h=function(){var d=C(E().mark(function p(){var m;return E().wrap(function(g){for(;;)switch(g.prev=g.next){case 0:return clearTimeout(o._timer),g.prev=1,g.next=4,o.load(t,r,e);case 4:if(m=g.sent,m[0]){g.next=7;break}return g.abrupt("return");case 7:u=o.hls.config.pollRetryCount,i(m[0],m[1],m[2]),g.next=15;break;case 11:g.prev=11,g.t0=g.catch(1),u--,u<=0&&n(g.t0);case 15:o._timer=setTimeout(h,s);case 16:case"end":return g.stop()}},p,null,[[1,11]])}));return function(){return d.apply(this,arguments)}}();this._timer=setTimeout(h,s)}},{key:"stopPoll",value:function(){return clearTimeout(this._timer),this.cancel()}},{key:"cancel",value:function(){return Promise.all([this._loader.cancel(),this._audioLoader.cancel()])}}]),l}();function Ve(l,a,t){return a>t&&(t=a),Math.min(Math.max(l,a),t)}var Se=new ae("playlist"),Re=function(){function l(a,t,r){V(this,l),c(this,"live",void 0),c(this,"id",0),c(this,"bitrate",0),c(this,"width",0),c(this,"height",0),c(this,"name",""),c(this,"url",""),c(this,"audioCodec",""),c(this,"videoCodec",""),c(this,"textCodec",""),c(this,"startCC",0),c(this,"endCC",0),c(this,"startSN",0),c(this,"endSN",-1),c(this,"totalDuration",0),c(this,"targetDuration",0),c(this,"partTargetDuration",0),c(this,"canSkipUntil",0),c(this,"canSkipDateRanges",!1),c(this,"skippedSegments",0),c(this,"canBlockReload",!1),c(this,"partHoldBack",0),c(this,"lowLatency",!1),c(this,"endPartIndex",0),c(this,"snDiff",null),c(this,"segments",[]),c(this,"audioStreams",[]),c(this,"subtitleStreams",[]),c(this,"closedCaptions",[]),c(this,"currentAudioStream",null),c(this,"currentSubtitleStream",null),this.update(this._setLLPlaybackPoint(a),t,r)}return F(l,[{key:"lastSegment",get:function(){return this.segments.length?this.segments[this.segments.length-1]:null}},{key:"segmentDuration",get:function(){var t;return this.targetDuration||((t=this.segments[0])===null||t===void 0?void 0:t.duration)||0}},{key:"liveEdge",get:function(){return this.endTime},set:function(t){this.endTime=t}},{key:"endTime",get:function(){var t;return((t=this.lastSegment)===null||t===void 0?void 0:t.end)||0},set:function(t){var r=this.lastSegment;r&&(r.duration=t-r.start)}},{key:"currentSubtitleEndSn",get:function(){var t;return((t=this.currentSubtitleStream)===null||t===void 0?void 0:t.endSN)||0}},{key:"clearOldSegment",value:function(t,r){return this.currentAudioStream&&this._clearSegments(t,r),this._clearSegments(t,r)}},{key:"getAudioSegment",value:function(t){if(!(!t||!this.currentAudioStream)){var r=t.sn-this.snDiff;return this.currentAudioStream.segments.find(function(e){return e.sn===r})}}},{key:"update",value:function(t,r){this.url=t.url,Array.isArray(t.segments)?((this.live===null||this.live===void 0)&&(this.live=t.live),this._updateSegments(t,this),this.startCC=t.startCC,this.endCC=t.endCC,this.startSN=t.startSN,this.endSN=t.endSN||-1,this.totalDuration=t.totalDuration,this.targetDuration=t.targetDuration,this.live=t.live,this.lowLatency=t.lowLatency,this.canBlockReload=t.canBlockReload,this.canSkipDateRanges=t.canSkipDateRanges,this.canSkipUntil=t.canSkipUntil,this.partHoldBack=t.partHoldBack,this.partTargetDuration=t.partTargetDuration,this.skippedSegments=t.skippedSegments,this.endPartIndex=t.endPartIndex,r&&this.currentAudioStream&&Array.isArray(r.segments)&&(this._updateSegments(r,this.currentAudioStream),(this.snDiff===null||this.snDiff===void 0)&&t.segments.length&&r.segments.length&&(this.snDiff=t.segments[0].sn-r.segments[0].sn))):(this.id=t.id,this.bitrate=t.bitrate,this.width=t.width,this.height=t.height,this.name=t.name,this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.textCodec=t.textCodec,this.audioStreams=t.audioStreams,this.subtitleStreams=t.subtitleStreams,!this.currentAudioStream&&this.audioStreams.length&&(this.currentAudioStream=this.audioStreams.find(function(e){return e.default})||this.audioStreams[0]),!this.currentSubtitleStream&&this.subtitleStreams.length&&(this.currentSubtitleStream=this.subtitleStreams.find(function(e){return e.default})||this.subtitleStreams[0]))}},{key:"updateSubtitle",value:function(t){var r=this;if(t&&this.currentSubtitleStream&&Array.isArray(t.segments)){var e=this._updateSegments(t,this.currentSubtitleStream),i=this.currentSubtitleStream.segments;if(i.length>100&&(this.currentSubtitleStream.segments=i.slice(100)),!!e)return e.map(function(n){return{sn:n.sn,url:n.url,duration:n.duration,start:n.start,end:n.end,lang:r.currentSubtitleStream.lang}})}}},{key:"switchSubtitle",value:function(t){var r=this.subtitleStreams.find(function(i){return i.lang===t}),e=this.currentSubtitleStream;r&&(this.currentSubtitleStream=r,e.segments=[])}},{key:"_setLLPlaybackPoint",value:function(t){if(!t.lowLatency||!t.segments.length)return t;for(var r=t.totalDuration-t.partHoldBack,e=t.segments,i=0,n=0,s=e.length;n<s;n++)e[n].start<=r&&e[n].independent&&(i=n);var o=e.slice(i),u=0;return o.forEach(function(h){h.start=u,u=h.end}),t.segments=o,t.totalDuration=u,t.startSN=o[0].sn,t.startCC=o[0].cc,Se.log("set ll-hls playback point: SN=".concat(t.startSN," partIndex=").concat(o[0].partIndex,", duration=").concat(u)),t}},{key:"_clearSegments",value:function(t,r){for(var e=0,i=this.segments,n=0,s=i.length;n<s;n++)if(i[n].end>=t){e=n;break}return e>r&&(e=r),e&&(this.segments=this.segments.slice(e),this.currentAudioStream&&(this.currentAudioStream.segments=this.currentAudioStream.segments.slice(e))),r-e}},{key:"_updateSegments",value:function(t,r){var e=r.segments;if(this.live){var i,n=t.lowLatency,s=e[e.length-1],o=(i=s==null?void 0:s.sn)!==null&&i!==void 0?i:-1,u=(s==null?void 0:s.partIndex)||0,h=o<t.endSN&&t.segments.length;if(n&&(h=h||u<t.endPartIndex),h){Se.log("update segments: endSN:".concat(o,", partIndex:").concat(u," --> endSN:").concat(t.endSN,", partIndex:").concat(t.endPartIndex));var d=t.segments.findIndex(function(y){return y.sn===o&&y.partIndex===u}),p=d<0?t.segments:t.segments.slice(d+1);if(e.length&&p.length){var m=s.end,f=m;p.forEach(function(y){y.start=m,m=y.end}),Se.log("liveEdge: ".concat(f," -> ").concat(m));var g=(s==null?void 0:s.cc)||-1;g>p[0].cc&&p.forEach(function(y){return y.cc+=g})}return r.endSN=t.endSN,r.segments=e.concat(p),p}}else r.segments=t.segments}}]),l}(),Ot=function(){function l(a){V(this,l),c(this,"streams",[]),c(this,"currentStream",null),c(this,"dvrWindow",0),c(this,"_segmentPointer",-1),this.hls=a}return F(l,[{key:"lowLatency",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.lowLatency}},{key:"lastSegment",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.lastSegment}},{key:"currentSegment",get:function(){var t;return(t=this.currentSegments)===null||t===void 0?void 0:t[this._segmentPointer]}},{key:"nextSegment",get:function(){var t;return(t=this.currentSegments)===null||t===void 0?void 0:t[this._segmentPointer+1]}},{key:"currentSegments",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.segments}},{key:"currentSubtitleEndSn",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.currentSubtitleEndSn}},{key:"liveEdge",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.liveEdge},set:function(t){this.currentStream&&(this.currentStream.liveEdge=t)}},{key:"totalDuration",get:function(){var t;return((t=this.currentStream)===null||t===void 0?void 0:t.totalDuration)||0}},{key:"seekRange",get:function(){var t=this.currentSegments;if(!(!t||!t.length))return[t[0].start,t[t.length-1].end]}},{key:"nbSegments",get:function(){var t;return((t=this.currentSegments)===null||t===void 0?void 0:t.length)||0}},{key:"isEmpty",get:function(){var t;return!((t=this.currentSegments)!==null&&t!==void 0&&t.length)}},{key:"isLive",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.live}},{key:"hadSegmentLoaded",get:function(){return this._segmentPointer!==-1}},{key:"hasSubtitle",get:function(){var t;return!!((t=this.currentStream)!==null&&t!==void 0&&t.currentSubtitleStream)}},{key:"getAudioSegment",value:function(t){var r;return(r=this.currentStream)===null||r===void 0?void 0:r.getAudioSegment(t)}},{key:"moveSegmentPointer",value:function(t){var r;t==null&&(t=this._segmentPointer+1),this._segmentPointer=Ve(t,-1,(r=this.currentSegments)===null||r===void 0?void 0:r.length)}},{key:"reset",value:function(){this.streams=[],this.currentStream=null,this.dvrWindow=0,this._segmentPointer=-1}},{key:"getSegmentByIndex",value:function(t){var r;return(r=this.currentSegments)===null||r===void 0?void 0:r[t]}},{key:"setNextSegmentByIndex",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;this._segmentPointer=t-1}},{key:"setNextSegmentBySN",value:function(){var t,r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,e=(t=this.currentSegments)===null||t===void 0?void 0:t.findIndex(function(i){return i.sn===r});return e!==-1&&this.setNextSegmentByIndex(e+1),e}},{key:"findSegmentIndexByTime",value:function(t){var r=this.currentSegments;if(r){for(var e=0,i=r.length,n;e<i;e++)if(n=r[e],t>=n.start&&t<n.end)return e;var s=r[r.length-1];if(Math.abs(t-(s==null?void 0:s.end))<.2)return r.length-1}}},{key:"upsertPlaylist",value:function(t,r,e){var i=this;if(t){if(t.isMaster)this.streams.length=t.streams.length,t.streams.filter(function(u){return u.url}).forEach(function(u,h){i.streams[h]?i.streams[h].update(u):i.streams[h]=new Re(u)}),this.currentStream=this.streams[0];else if(Array.isArray(t.segments)){var n=this.currentStream;if(n){n.update(t,r,e);var s=n.updateSubtitle(e);s&&this.hls.emit(P.SUBTITLE_SEGMENTS,{list:s})}else this.reset(),this.currentStream=this.streams[0]=new Re(t,r,e)}var o=this.currentStream;o&&this.hls.isLive&&!this.dvrWindow&&(this.dvrWindow=this.currentSegments.reduce(function(u,h){return u+=h.duration,u},0))}}},{key:"updateSegmentsRanges",value:function(t,r){var e,i=(e=this.currentSegments)===null||e===void 0?void 0:e.filter(function(n){return n.sn>=t});i.forEach(function(n){n.start=r,r=n.end})}},{key:"switchSubtitle",value:function(t){var r;(r=this.currentStream)===null||r===void 0||r.switchSubtitle(t)}},{key:"clearOldSegment",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:50,r=this.currentStream;if(!(!this.dvrWindow||!r)){var e=r.endTime-this.dvrWindow;if(!(e<=0)){var i=r.segments;i.length<=t||(this._segmentPointer=r.clearOldSegment(e,this._segmentPointer))}}}},{key:"checkSegmentTrackChange",value:function(t,r){var e=this.findSegmentIndexByTime(t),i=this.getSegmentByIndex(e);if(i&&!(!i.hasAudio&&!i.hasVideo)){if(r!==2&&i.hasAudio&&i.hasVideo)return i;if(!(i.end-t>.3)){var n=this.getSegmentByIndex(e+1);if(n&&!(!n.hasAudio&&!n.hasVideo)&&(n.hasAudio!==i.hasAudio||n.hasVideo!==i.hasVideo))return n}}}},{key:"feedbackLiveEdge",value:function(t,r){var e,i=this.currentSegments;if(i){var n=((e=this.lastSegment)===null||e===void 0?void 0:e.sn)===t.sn;if(n){this.liveEdge=r;return}this.updateSegmentsRanges(t.sn+1,r)}}}]),l}(),Rt=function(){function l(a){var t=this;V(this,l),c(this,"error",null),c(this,"_emitOnLoaded",function(o,u){var h=o.data,d=o.response,p=o.options,m=p||{},f=m.firstByteTime,g=m.startTime,y=m.endTime,b=m.contentLength,A=y-g;t._bandwidthService.addRecord(b||h.byteLength,A),t.hls.emit(I.SPEED,{time:A,byteLength:b,url:u}),t.hls.emit(I.LOAD_COMPLETE,{url:u,elapsed:A||0}),t.hls.emit(I.TTFB,{url:u,responseUrl:d.url,elapsed:f-g}),t.hls.emit(I.LOAD_RESPONSE_HEADERS,{headers:d.headers,url:u})}),c(this,"_onLoaderRetry",function(o,u){t.hls.emit(I.LOAD_RETRY,{error:Y.network(o),retryTime:u})}),this.hls=a,this._bandwidthService=new He,this._mapCache={},this._keyCache={};var r=this.hls.config,e=r.retryCount,i=r.retryDelay,n=r.loadTimeout,s=r.fetchOptions;this._segmentLoader=new ne(O(O({},s),{},{responseType:"arraybuffer",retry:e,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry})),this._audioSegmentLoader=new ne(O(O({},s),{},{responseType:"arraybuffer",retry:e,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry})),this._keyLoader=new ne(O(O({},s),{},{responseType:"arraybuffer",retry:e,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry}))}return F(l,[{key:"speedInfo",value:function(){return{speed:this._bandwidthService.getLatestSpeed(),avgSpeed:this._bandwidthService.getAvgSpeed()}}},{key:"load",value:function(t,r,e){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:e,n=[];return t&&(n[0]=this.loadVideoSegment(t,e)),r&&(n[1]=this.loadAudioSegment(r,i)),Promise.all(n)}},{key:"loadVideoSegment",value:function(t,r){return this._loadSegment(this._segmentLoader,t,r)}},{key:"loadAudioSegment",value:function(t,r){return this._loadSegment(this._audioSegmentLoader,t,r)}},{key:"_loadSegment",value:function(){var a=C(E().mark(function r(e,i,n){var s=this,o,u,h,d,p,m,f,g,y,b,A,T,k,M,U;return E().wrap(function(H){for(;;)switch(H.prev=H.next){case 0:return f=[],this.hls.emit(I.LOAD_START,{url:i.url}),f[0]=e.load(i.url),n&&i.initSegment&&(y=i.initSegment.url,u=this._mapCache[y],u||(this.hls.emit(I.LOAD_START,{url:y}),f[1]=e.load(y).then(function(R){if(R){var B=Object.keys(s._mapCache);B>30&&(s._mapCache={}),u=s._mapCache[y]=R.data,s._emitOnLoaded(R,y)}})),b=(g=i.initSegment.key)===null||g===void 0?void 0:g.url,b&&(m=i.initSegment.key.iv,p=this._keyCache[b],p||(this.hls.emit(I.LOAD_START,{url:b}),f[2]=this._keyLoader.load(b).then(function(R){R&&(p=s._keyCache[b]=R.data,s._emitOnLoaded(R,b))})))),A=(o=i.key)===null||o===void 0?void 0:o.url,A&&i.key.isSegmentEncrypted()&&(d=i.key.iv,h=this._keyCache[A],h||(this.hls.emit(I.LOAD_START,{url:A}),f[3]=this._keyLoader.load(A).then(function(R){R&&(h=s._keyCache[A]=R.data,s._emitOnLoaded(R,A))}))),H.next=8,Promise.all(f);case 8:if(T=H.sent,k=z(T,1),M=k[0],M){H.next=13;break}return H.abrupt("return");case 13:return U=M.data,this._emitOnLoaded(M,i.url),H.abrupt("return",{data:U,map:u,key:h,mapKey:p,keyIv:d,mapKeyIv:m});case 16:case"end":return H.stop()}},r,this)}));function t(r,e,i){return a.apply(this,arguments)}return t}()},{key:"reset",value:function(){this.error=null,this._mapCache={},this._keyCache={},this._bandwidthService.reset()}},{key:"cancel",value:function(){var a=C(E().mark(function r(){return E().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,Promise.all([this._keyLoader.cancel(),this._segmentLoader.cancel(),this._audioSegmentLoader.cancel()]);case 2:case"end":return i.stop()}},r,this)}));function t(){return a.apply(this,arguments)}return t}()}]),l}(),j=new ae("hls"),se=function(l){me(t,l);var a=ve(t);function t(r){var e;return V(this,t),e=a.call(this),c(D(e),"version",t.version),c(D(e),"media",null),c(D(e),"config",null),c(D(e),"_manifestLoader",null),c(D(e),"_segmentLoader",null),c(D(e),"_playlist",null),c(D(e),"_bufferService",null),c(D(e),"_gapService",null),c(D(e),"_seiService",null),c(D(e),"_stats",null),c(D(e),"_prevSegSn",null),c(D(e),"_prevSegCc",null),c(D(e),"_tickTimer",null),c(D(e),"_tickInterval",500),c(D(e),"_segmentProcessing",!1),c(D(e),"_reloadOnPlay",!1),c(D(e),"_switchUrlOpts",null),c(D(e),"_isProcessQuotaExceeded",!1),c(D(e),"_loadSegment",C(E().mark(function i(){var n,s,o,u,h;return E().wrap(function(p){for(;;)switch(p.prev=p.next){case 0:if(!(e._segmentProcessing||!e.media)){p.next=2;break}return p.abrupt("return");case 2:if(n=e._playlist.nextSegment,s=D(e),o=s.config,n){p.next=6;break}return p.abrupt("return");case 6:if(e.isLive){p.next=16;break}if(u=e.bufferInfo(),e.media.paused&&!e.media.currentTime&&(u=e.bufferInfo(u.nextStart||.5)),h=Math.abs(u.end-e.media.duration)<.1,!(u.remaining>=o.preloadTime||h)){p.next=13;break}return e._tryEos(),p.abrupt("return");case 13:if(!(o.preferMMSStreaming&&!e._bufferService.msStreaming)){p.next=15;break}return p.abrupt("return");case 15:!e._urlSwitching&&e._prevSegSn!==n.sn-1&&u.end&&Math.abs(n.start-u.end)>1&&e._playlist.setNextSegmentByIndex(e._playlist.findSegmentIndexByTime(u.end+.1));case 16:return p.abrupt("return",e._loadSegmentDirect());case 17:case"end":return p.stop()}},i)}))),c(D(e),"_onLoadeddata",function(){e.isLive&&!e.config.mseLowLatency&&e.media.duration!==1/0&&e._bufferService.updateDuration(1/0).catch(function(i){})}),c(D(e),"_onPlay",C(E().mark(function i(){return E().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(!(e.media.seeking&&e.media.currentTime===0)){s.next=3;break}return j.debug("replay currentTime 0, return"),s.abrupt("return");case 3:if(clearTimeout(e._disconnectTimer),!e._reloadOnPlay){s.next=9;break}e._reloadOnPlay=!1,e.replay(!0),s.next=12;break;case 9:return s.next=11,e._loadSegment();case 11:e._startTick();case 12:case"end":return s.stop()}},i)}))),c(D(e),"_onPause",function(){if(e.isLive){if(!e._reloadOnPlay){var i=e.config.disconnectTime;if(i==null&&(i=e._playlist.dvrWindow),!Number.isFinite(i))return;clearTimeout(e._disconnectTimer),e._disconnectTimer=setTimeout(function(){e._reloadOnPlay=!0,e._clear()},i||0)}}else e._stopTick()}),c(D(e),"_onSeeking",C(E().mark(function i(){var n,s,o,u,h,d,p;return E().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(e.media){f.next=2;break}return f.abrupt("return");case 2:if(e._onCheckQuotaExceeded(),n=e.media.currentTime,s=e._playlist.seekRange,!s){f.next=10;break}if(o=Ve(n,s[0],e.isLive?s[1]:e.media.duration),!(o>=0&&Math.abs(n-o)>=.1)){f.next=10;break}return e.media.currentTime=o,f.abrupt("return");case 10:if(u=e._playlist.currentSegment,h=q.info(q.get(e.media),n,.1),!u){f.next=17;break}if(!(h.end&&Math.abs(h.end-u.end)<.2)){f.next=15;break}return f.abrupt("return");case 15:if(!(e.isLive&&h.end)){f.next=17;break}return f.abrupt("return");case 17:if(d=e._playlist.findSegmentIndexByTime(n),p=e._playlist.getSegmentByIndex(d),!(d==null||!p||e._segmentProcessing&&p===e._playlist.nextSegment)){f.next=21;break}return f.abrupt("return");case 21:return j.debug("seek to",n,p),e._playlist.setNextSegmentByIndex(d),e._stopTick(),f.next=26,e._segmentLoader.cancel();case 26:if(e._segmentProcessing=!1,!(!h.end||e.isLive)){f.next=30;break}return f.next=30,e._loadSegmentDirect(!0);case 30:e._startTick();case 31:case"end":return f.stop()}},i)}))),c(D(e),"_onTimeupdate",function(){if(e.media){var i=e.config;if(i.isLive&&i.maxLatency&&i.targetLatency&&e.media){var n=e._playlist.liveEdge;if(!n)return;var s=n-e.media.currentTime;s>=i.maxLatency&&(j.debug("latency jump, currentTime:".concat(e.media.currentTime,", liveEdge:").concat(n,",  latency=").concat(s)),e.media.currentTime=n-i.targetLatency)}if(i.seiInTime){var o;(o=e._seiService)===null||o===void 0||o.throw(e.media.currentTime)}e.config.allowedStreamTrackChange&&!e.config.softDecode&&e._checkStreamTrackChange(e.media.currentTime)}}),c(D(e),"_tick",function(){if(e.media){e._startTick();var i=e.media,n=q.get(i),s=e._segmentLoader.error;if(e._onCheckQuotaExceeded(),e._isProcessQuotaExceeded&&(e._bufferService.isFull()||(e._isProcessQuotaExceeded=!1,e._segmentProcessing=!1)),s){var o=.5;(!i.readyState||e.bufferInfo(o).remaining<1)&&(s.fatal=!0,e._emitError(Y.network(s)));return}q.end(n)>=.1&&i.readyState&&(Ye(i)?(e._loadSegment(),e._gapService&&e._gapService.do(i,e.config.maxJumpDistance,e.isLive)):i.readyState<2&&e._gapService&&e._gapService.do(i,e.config.maxJumpDistance,i.currentTime?e.isLive:!0)),e.isLive||e._tryEos()}}),e.config=r=pt(r),e.media=e.config.media,e._manifestLoader=new Pt(D(e)),e._segmentLoader=new Rt(D(e)),e._playlist=new Ot(D(e)),e._bufferService=new vt(D(e)),r.seiInTime&&(e._seiService=new je(D(e))),r.softDecode||(e._gapService=new We),e._stats=new xe(D(e),9e4),e.media.addEventListener("loadeddata",e._onLoadeddata),e.media.addEventListener("play",e._onPlay),e.media.addEventListener("pause",e._onPause),e.media.addEventListener("seeking",e._onSeeking),e.media.addEventListener("timeupdate",e._onTimeupdate),e}return F(t,[{key:"isLive",get:function(){return this._playlist.isLive}},{key:"streams",get:function(){return this._playlist.streams}},{key:"currentStream",get:function(){return this._playlist.currentStream}},{key:"hasSubtitle",get:function(){return this._playlist.hasSubtitle}},{key:"totalDuration",get:function(){return this._playlist.totalDuration}},{key:"baseDts",get:function(){var e;return(e=this._bufferService)===null||e===void 0?void 0:e.baseDts}},{key:"speedInfo",value:function(){return this._segmentLoader.speedInfo()}},{key:"bufferInfo",value:function(){var e,i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:.1;return q.info(q.get(this.media),(e=this.media)===null||e===void 0?void 0:e.currentTime,i)}},{key:"getStats",value:function(){return this._stats.getStats()}},{key:"playbackQuality",value:function(){return Ke(this.media)}},{key:"load",value:function(){var r=C(E().mark(function i(n){var s,o=arguments;return E().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return s=o.length>1&&o[1]!==void 0?o[1]:!1,n&&(this.config.url=n),n=this.config.url,h.next=5,this._reset(s);case 5:return h.next=7,this._loadData(n);case 7:this._startTick();case 8:case"end":return h.stop()}},i,this)}));function e(i){return r.apply(this,arguments)}return e}()},{key:"_loadData",value:function(){var r=C(E().mark(function i(n){var s,o,u,h,d,p,m,f,g,y,b;return E().wrap(function(T){for(;;)switch(T.prev=T.next){case 0:try{n&&(n=n.trim())}catch{}if(n){T.next=3;break}throw this._emitError(new Y(X.OTHER,X.SUB_TYPES.OPTION,null,null,"m3u8 url is missing"));case 3:return T.next=5,this._loadM3U8(n);case 5:if(s=T.sent,o=this._playlist.currentStream,!(this._urlSwitching&&!this.isLive)){T.next=17;break}if(o.bitrate===0&&(u=this._switchUrlOpts)!==null&&u!==void 0&&u.bitrate&&(o.bitrate=(h=this._switchUrlOpts)===null||h===void 0?void 0:h.bitrate),d=this._getSeamlessSwitchPoint(),this.config.startTime=d,p=this._playlist.findSegmentIndexByTime(d),m=this._playlist.getSegmentByIndex(p+1),!m){T.next=17;break}return f=m.start,T.next=17,this._bufferService.removeBuffer(f);case 17:if(this._urlSwitching&&this.isLive&&(g=this._playlist.setNextSegmentBySN(this._prevSegSn),j.log("segment nb=".concat(this._prevSegSn," index of ").concat(g," in the new playlist")),g===-1&&(this._prevSegCc=null,this._prevSegSn=null)),s){T.next=20;break}return T.abrupt("return");case 20:if(!this.isLive){T.next=31;break}if(this._bufferService.setLiveSeekableRange(0,4294967295),j.log("totalDuration first time got:",this._playlist.totalDuration),j.log("nb segments got:",this._playlist.nbSegments),this.config.targetLatency<this._playlist.totalDuration&&(this.config.targetLatency=this._playlist.totalDuration,this.config.maxLatency=1.5*this.config.targetLatency),s.isMaster||this._pollM3U8(n),!(this._playlist.nbSegments<this.config.minSegmentsStartPlay)){T.next=28;break}return T.abrupt("return");case 28:return T.next=30,this._loadSegment();case 30:return T.abrupt("return");case 31:return T.next=33,this._bufferService.updateDuration(o.totalDuration);case 33:return y=this.config.startTime,y&&((b=this._switchUrlOpts)!==null&&b!==void 0&&b.seamless||(this.media.currentTime=y),this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(y)||0)),T.next=37,this._loadSegment();case 37:case"end":return T.stop()}},i,this)}));function e(i){return r.apply(this,arguments)}return e}()},{key:"replay",value:function(){var r=C(E().mark(function i(n){return E().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return this.config.startTime=0,o.next=3,this.load();case 3:return this._reloadOnPlay=!1,o.abrupt("return",this.media.play(!n));case 5:case"end":return o.stop()}},i,this)}));function e(i){return r.apply(this,arguments)}return e}()},{key:"switchURL",value:function(){var r=C(E().mark(function i(n){var s,o,u,h,d,p,m,f=arguments;return E().wrap(function(y){for(;;)switch(y.prev=y.next){case 0:s=f.length>1&&f[1]!==void 0?f[1]:{},o={seamless:!1,startTime:0,bitrate:0},y.t0=fe(s),y.next=y.t0==="number"?5:y.t0==="boolean"?7:y.t0==="object"?9:11;break;case 5:return s={startTime:s},y.abrupt("break",12);case 7:return s={seamless:s},y.abrupt("break",12);case 9:for(u in s)(s[u]===void 0||s[u]===null)&&delete s[u];return y.abrupt("break",12);case 11:throw"unsupported switchURL args: ".concat(s);case 12:if(s=Object.assign({},o,s),h=s,d=h.seamless,p=h.startTime,this.config.url=n,this.config.startTime=p,this._switchUrlOpts=s,d){y.next=38;break}if(y.prev=18,!this.config.softDecode){y.next=23;break}y.t1=this.load(n),y.next=26;break;case 23:return y.next=25,this.load(n);case 25:y.t1=y.sent;case 26:m=y.t1,y.next=33;break;case 29:throw y.prev=29,y.t2=y.catch(18),this.emit(P.SWITCH_URL_FAILED,y.t2),y.t2;case 33:return this._reloadOnPlay=!1,m&&this.emit(P.SWITCH_URL_SUCCESS,{url:n}),y.abrupt("return",this.media.play(!0));case 38:return this._urlSwitching=!0,this.isLive||(this._prevSegSn=null,this._prevSegCc=null),this._playlist.reset(),this._bufferService.seamlessSwitch(),y.next=44,this._clear();case 44:return y.next=46,this._loadData(n);case 46:this._startTick();case 47:this._switchUrlOpts=null;case 48:case"end":return y.stop()}},i,this,[[18,29]])}));function e(i){return r.apply(this,arguments)}return e}()},{key:"switchStream",value:function(){var r=C(E().mark(function i(n){var s,o,u,h,d,p=arguments;return E().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(s=p.length>1&&p[1]!==void 0?p[1]:!0,o=this.currentStream,u=this.streams,!(!o||o.id===n||!u||u.length<2)){f.next=5;break}return f.abrupt("return");case 5:if(h=u.find(function(g){return g.id===n}),h){f.next=8;break}return f.abrupt("return");case 8:return f.prev=8,f.next=11,this._clear();case 11:if(!s){f.next=14;break}return f.next=14,this._bufferService.clearAllBuffer();case 14:f.next=19;break;case 16:throw f.prev=16,f.t0=f.catch(8),this._emitError(Y.create(f.t0));case 19:if(o.currentAudioStream&&h.audioStreams.length>2&&(d=o.currentAudioStream.id,h.currentAudioStream=h.audioStreams.find(function(g){return g.id===d})||h.currentAudioStream),this._playlist.currentStream=h,f.prev=21,!(this.isLive||!h.segments.length)){f.next=25;break}return f.next=25,this._refreshM3U8();case 25:return this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(this.media.currentTime)||0),this._prevSegCc=null,f.next=29,this._loadSegmentDirect();case 29:f.next=35;break;case 31:throw f.prev=31,f.t1=f.catch(21),this._playlist.currentStream=o,f.t1;case 35:return this._startTick(),f.abrupt("return",h);case 37:case"end":return f.stop()}},i,this,[[8,16],[21,31]])}));function e(i){return r.apply(this,arguments)}return e}()},{key:"switchAudioStream",value:function(){var r=C(E().mark(function i(n){var s,o,u,h,d=arguments;return E().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:if(s=d.length>1&&d[1]!==void 0?d[1]:!0,o=this.currentStream,o){m.next=4;break}return m.abrupt("return");case 4:if(u=o.currentAudioStream,!(!u||u.id===n||o.audioStreams.length<2)){m.next=7;break}return m.abrupt("return");case 7:if(h=o.audioStreams.find(function(f){return f.id===n}),h){m.next=10;break}return m.abrupt("return");case 10:return m.prev=10,m.next=13,this._clear();case 13:if(!s){m.next=16;break}return m.next=16,this._bufferService.clearAllBuffer();case 16:m.next=21;break;case 18:throw m.prev=18,m.t0=m.catch(10),this._emitError(Y.create(m.t0));case 21:if(o.currentAudioStream=h,m.prev=22,!(this.isLive||!h.segments.length)){m.next=26;break}return m.next=26,this._refreshM3U8();case 26:return this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(this.media.currentTime)||0),this._prevSegCc=null,m.next=30,this._loadSegmentDirect();case 30:m.next=36;break;case 32:throw m.prev=32,m.t1=m.catch(22),o.currentAudioStream=u,m.t1;case 36:return this._startTick(),m.abrupt("return",h);case 38:case"end":return m.stop()}},i,this,[[10,18],[22,32]])}));function e(i){return r.apply(this,arguments)}return e}()},{key:"switchSubtitleStream",value:function(){var r=C(E().mark(function i(n){return E().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return this._playlist.switchSubtitle(n),o.next=3,this._manifestLoader.stopPoll();case 3:return o.next=5,this._refreshM3U8();case 5:case"end":return o.stop()}},i,this)}));function e(i){return r.apply(this,arguments)}return e}()},{key:"destroy",value:function(){var r=C(E().mark(function i(){var n;return E().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(this.media){o.next=2;break}return o.abrupt("return");case 2:return this.removeAllListeners(),this._playlist.reset(),this._segmentLoader.reset(),(n=this._seiService)===null||n===void 0||n.reset(),this.media.removeEventListener("loadeddata",this._onLoadeddata),this.media.removeEventListener("play",this._onPlay),this.media.removeEventListener("pause",this._onPause),this.media.removeEventListener("seeking",this._onSeeking),this.media.removeEventListener("timeupdate",this._onTimeupdate),o.next=13,Promise.all([this._clear(),this._bufferService.destroy()]);case 13:this.media=null;case 14:case"end":return o.stop()}},i,this)}));function e(){return r.apply(this,arguments)}return e}()},{key:"_loadM3U8",value:function(){var r=C(E().mark(function i(n){var s,o,u,h,d,p,m;return E().wrap(function(g){for(;;)switch(g.prev=g.next){case 0:if(g.prev=0,h=(o=this.config.manifestList)===null||o===void 0||(u=o.filter(function(y){return y.url===n})[0])===null||u===void 0?void 0:u.manifest,!h){g.next=6;break}g.t0=this._manifestLoader.parseText(h,n),g.next=9;break;case 6:return g.next=8,this._manifestLoader.load(n);case 8:g.t0=g.sent;case 9:d=g.t0,p=z(d,1),s=p[0],g.next=17;break;case 14:throw g.prev=14,g.t1=g.catch(0),this._emitError(Y.create(g.t1));case 17:if(s){g.next=19;break}return g.abrupt("return");case 19:if(this._playlist.upsertPlaylist(s),!s.isMaster){g.next=24;break}return(m=this._playlist.currentStream.subtitleStreams)!==null&&m!==void 0&&m.length&&this.emit(P.SUBTITLE_PLAYLIST,{list:this._playlist.currentStream.subtitleStreams}),g.next=24,this._refreshM3U8();case 24:return this.emit(P.STREAM_PARSED),g.abrupt("return",s);case 26:case"end":return g.stop()}},i,this,[[0,14]])}));function e(i){return r.apply(this,arguments)}return e}()},{key:"_refreshM3U8",value:function(){var e,i,n=this,s=this._playlist.currentStream;if(!s||!s.url)throw this._emitError(Y.create(null,null,new Error("m3u8 url is not defined")));var o=s.url,u=(e=s.currentAudioStream)===null||e===void 0?void 0:e.url,h=(i=s.currentSubtitleStream)===null||i===void 0?void 0:i.url;return this._manifestLoader.load(o,u,h).then(function(d){var p=z(d,3),m=p[0],f=p[1],g=p[2];m&&(n._playlist.upsertPlaylist(m,f,g),n.isLive&&n._pollM3U8(o,u,h))}).catch(function(d){throw n._emitError(Y.create(d))})}},{key:"_pollM3U8",value:function(e,i,n){var s=this,o=this._playlist.isEmpty,u;if(this._playlist.lowLatency)u=(this._playlist.currentStream.partTargetDuration*2||0)*1e3;else{var h;u=(((h=this._playlist.lastSegment)===null||h===void 0?void 0:h.duration)||0)*1e3}this._manifestLoader.poll(e,i,n,function(d,p,m){s._playlist.upsertPlaylist(d,p,m),s._playlist.clearOldSegment();var f=d&&o&&!s._playlist.isEmpty;(f||!s._playlist.hadSegmentLoaded&&s._playlist.nbSegments>=s.config.minSegmentsStartPlay)&&s._loadSegment(),o&&(o=s._playlist.isEmpty)},function(d){s._emitError(Y.create(d))},u)}},{key:"_loadSegmentDirect",value:function(){var r=C(E().mark(function i(n){var s,o,u,h,d,p;return E().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(s=this._playlist.nextSegment,s){f.next=3;break}return f.abrupt("return");case 3:return o=!1,u=null,f.prev=5,this._segmentProcessing=!0,j.log("load segment, sn:".concat(s.sn,", [").concat(s.start,", ").concat(s.end,"], partIndex:").concat(s.partIndex)),f.next=10,this._reqAndBufferSegment(s,this._playlist.getAudioSegment(s));case 10:o=f.sent,f.next=16;break;case 13:f.prev=13,f.t0=f.catch(5),u=f.t0;case 16:return f.prev=16,this._segmentProcessing=!1,f.finish(16);case 19:if(!u){f.next=26;break}if(!this._bufferService.isFull()){f.next=25;break}return j.log("load segment, sn:".concat(s.sn,", partIndex:").concat(s.partIndex)),this._segmentProcessing=!0,this._isProcessQuotaExceeded=!0,f.abrupt("return",!1);case 25:return f.abrupt("return",this._emitError(Y.create(u)));case 26:return o&&(d=this.bufferInfo().end,this.isLive&&!this.media.seeking&&d&&Math.abs(s.end-d)>1&&(j.warn("segment: ".concat(s.sn," expected end=").concat(s.end,", real end=").concat(d)),this._playlist.feedbackLiveEdge(s,d)),p=((h=this._playlist.currentStream)===null||h===void 0?void 0:h.url)===s.parentUrl,this._urlSwitching&&!p&&(j.warn("pre playlist segment appended!"),this._bufferService.seamlessSwitch()),this.isLive&&this._urlSwitching&&p&&(this._urlSwitching=!1,this.emit(P.SWITCH_URL_SUCCESS,{url:this.config.url})),this._playlist.moveSegmentPointer(),s.isLast?this._end():n||this._loadSegment()),f.abrupt("return",o);case 28:case"end":return f.stop()}},i,this,[[5,13,16,19]])}));function e(i){return r.apply(this,arguments)}return e}()},{key:"_reqAndBufferSegment",value:function(){var r=C(E().mark(function i(n,s){var o,u,h,d,p,m,f,g,y,b,A;return E().wrap(function(k){for(;;)switch(k.prev=k.next){case 0:return u=n?n.cc:s.cc,h=this._prevSegCc!==u,d=[],k.prev=3,k.next=6,this._segmentLoader.load(n,s,h);case 6:d=k.sent,k.next=14;break;case 9:throw k.prev=9,k.t0=k.catch(3),k.t0.fatal=!1,this._segmentLoader.error=k.t0,k.t0;case 14:if(d[0]){k.next=16;break}return k.abrupt("return");case 16:return k.next=18,(o=this._bufferService).decryptBuffer.apply(o,at(d));case 18:if(p=k.sent,p){k.next=21;break}return k.abrupt("return");case 21:return m=n?n.sn:s.sn,f=n?n.start:s.start,g=this._playlist.currentStream,this._bufferService.createSource(p[0],p[1],g==null?void 0:g.videoCodec,g==null?void 0:g.audioCodec),y=Date.now(),b=this._prevSegSn===m-1,this.isLive&&this._urlSwitching&&(A=this.bufferInfo().end,this._playlist.updateSegmentsRanges(m,A),j.warn("update the new playlist liveEdge, segment id=".concat(m,", buffer start=").concat(A,", liveEdge=").concat(this._playlist.liveEdge)),f=A),k.next=30,this._bufferService.appendBuffer(n,s,p[0],p[1],h,b,f);case 30:return this.emit(P.APPEND_COST,{elapsed:Date.now()-y,url:n.url}),k.next=33,this._bufferService.evictBuffer(this.config.bufferBehind);case 33:return this._prevSegCc=u,this._prevSegSn=m,k.abrupt("return",!0);case 36:case"end":return k.stop()}},i,this,[[3,9]])}));function e(i,n){return r.apply(this,arguments)}return e}()},{key:"_onCheckQuotaExceeded",value:function(){var r=C(E().mark(function i(){var n,s,o,u,h,d;return E().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:n=this.media.currentTime,s=this.media.buffered,o=!1,u=0;case 4:if(!(u<s.length)){m.next=11;break}if(!(s.start(0)>=n&&n<s.end(u))){m.next=8;break}return o=!0,m.abrupt("break",11);case 8:u++,m.next=4;break;case 11:if(!this._bufferService.isFull()){m.next=17;break}if(h=o?this.config.bufferBehind:5,d=this.media.currentTime,!(d-h>0)){m.next=17;break}return m.next=17,this._bufferService.removeBuffer(0,d-h);case 17:case"end":return m.stop()}},i,this)}));function e(){return r.apply(this,arguments)}return e}()},{key:"_checkStreamTrackChange",value:function(e){var i=this._playlist.checkSegmentTrackChange(e,this._bufferService.nbSb);i&&this.switchURL(this.config.url,i.start+.2)}},{key:"_clear",value:function(){var r=C(E().mark(function i(){return E().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return clearTimeout(this._disconnectTimer),this._stopTick(),s.next=4,Promise.all([this._segmentLoader.cancel(),this._manifestLoader.stopPoll()]);case 4:this._segmentProcessing=!1;case 5:case"end":return s.stop()}},i,this)}));function e(){return r.apply(this,arguments)}return e}()},{key:"_reset",value:function(){var r=C(E().mark(function i(){var n,s,o=arguments;return E().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return s=o.length>0&&o[0]!==void 0?o[0]:!1,this._reloadOnPlay=!1,this._prevSegSn=null,this._prevSegCc=null,this._switchUrlOpts=null,this._playlist.reset(),this._segmentLoader.reset(),(n=this._seiService)===null||n===void 0||n.reset(),this._stats.reset(),h.next=11,this._clear();case 11:return h.abrupt("return",this._bufferService.reset(s));case 12:case"end":return h.stop()}},i,this)}));function e(){return r.apply(this,arguments)}return e}()},{key:"_end",value:function(){this._clear(),this._bufferService.endOfStream(),(this.media.readyState<=2||this.media.buffered.length>1)&&this._startTick()}},{key:"_stopTick",value:function(){this._tickTimer&&clearTimeout(this._tickTimer),this._tickTimer=null}},{key:"_startTick",value:function(){this._stopTick(),this._tickTimer=setTimeout(this._tick,this._tickInterval)}},{key:"_emitError",value:function(e){var i,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(((i=e.originError)===null||i===void 0?void 0:i.fatal)===!1)j.warn(e);else{var s,o,u;j.table(e),j.error(e),j.error((s=this.media)===null||s===void 0?void 0:s.error),(o=this.media)!==null&&o!==void 0&&o.readyState&&this.media.pause(),this._stopTick(),this._urlSwitching&&(this._urlSwitching=!1,this.emit(P.SWITCH_URL_FAILED,e)),this.emit(P.ERROR,e),n&&this._end(),(u=this._seiService)===null||u===void 0||u.reset()}return e}},{key:"_getSeamlessSwitchPoint",value:function(){var e=this.media,i=e.currentTime;if(!e.paused){var n,s=this._playlist.findSegmentIndexByTime(e.currentTime),o=this._playlist.getSegmentByIndex(s),u=(n=this._stats)===null||n===void 0?void 0:n.getStats().downloadSpeed;if(u&&o){var h=o.duration*this._playlist.currentStream.bitrate/u+1;i+=h}else i+=5}return i}},{key:"_tryEos",value:function(){var e,i,n=this.media,s=this._playlist,o=s.nextSegment,u=s.lastSegment,h=!o&&n.readyState&&n.duration>0&&((e=this._bufferService)===null||e===void 0?void 0:e.msIsOpened)&&!((i=this._bufferService)!==null&&i!==void 0&&i.msHasOpTasks);if(h){var d=this.bufferInfo();n.paused&&!n.currentTime&&(d=this.bufferInfo(d.nextStart||.5));var p=Math.abs(d.end-n.duration)<.1||!this.isLive&&u&&d.end>=u.start+u.duration;p&&this._bufferService.endOfStream()}}}],[{key:"isSupported",value:function(e){return!e||e==="video"||e==="audio"?K.isSupported():typeof WebAssembly<"u"}},{key:"enableLogger",value:function(){ae.enable(),ke.enable()}},{key:"disableLogger",value:function(){ae.disable(),ke.disable()}}]),t}(Ge);c(se,"version","3.0.18");try{localStorage.getItem("xgd")?se.enableLogger():se.disableLogger()}catch{}var Ct=function(){function l(a,t){var r=this;V(this,l),c(this,"_opts",null),c(this,"_plugin",null),c(this,"_onLowDecode",function(){var e,i,n,s,o=r._opts,u=o.media,h=o.innerDegrade;(e=r._plugin)===null||e===void 0||(i=e.player)===null||i===void 0||i.emit("lowdecode",u.degradeInfo),(n=r._plugin)===null||n===void 0||(s=n.player)===null||s===void 0||s.emit("core_event",O(O({},u.degradeInfo),{},{eventName:P.LOWDECODE})),h===1&&r._degrade(u.src)}),c(this,"_degrade",function(e){var i=r._plugin.player,n=i.video;if(!(n&&n.TAG!=="MVideo")){var s=i.video.degradeVideo;i.video=s,n.degrade(e),e&&(i.config.url=e);var o=i.root.firstChild;o.TAG==="MVideo"&&i.root.replaceChild(s,o);var u=r._plugin.constructor.pluginName.toLowerCase();i.unRegisterPlugin(u),i.once("canplay",function(){i.play()})}}),c(this,"forceDegradeToVideo",function(e){var i=r._opts.innerDegrade;i===1&&r._degrade(e)}),this._opts=a,this._plugin=t,this._init()}return F(l,[{key:"_init",value:function(){var t=this._opts,r=t.media,e=t.preloadTime,i=t.innerDegrade,n=t.isLive;if(r){if(!n&&r.setPlayMode){r.setPlayMode("VOD");return}i&&r.setAttribute("innerdegrade",i),e&&r.setAttribute("preloadtime",e),this._bindEvents()}}},{key:"_bindEvents",value:function(){var t=this._opts.media;t.addEventListener("lowdecode",this._onLowDecode)}},{key:"destroy",value:function(){var t,r;(t=this._opts)===null||t===void 0||(r=t.media)===null||r===void 0||r.removeEventListener("lowdecode",this._onLowDecode),this._plugin=null}}]),l}();function Mt(l,a){var t=a.player,r=t.currentTime,e={startTime:r};switch(fe(l)){case"boolean":e.seamless=l;break;case"object":Object.assign(e,l);break}return e}var Fe=function(l){me(t,l);var a=ve(t);function t(){var r;V(this,t);for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return r=a.call.apply(a,[this].concat(i)),c(D(r),"hls",null),c(D(r),"pluginExtension",null),c(D(r),"getStats",function(){var s;return(s=r.hls)===null||s===void 0?void 0:s.getStats()}),c(D(r),"_onSwitchSubtitle",function(s){var o,u=s.lang;(o=r.hls)===null||o===void 0||o.switchSubtitleStream(u)}),c(D(r),"_onSwitchURL",function(s,o){return new Promise(function(u,h){var d=D(r),p=d.player,m=d.hls;if(m){var f,g,y=Mt(o,D(r));p.config.url=s,m.switchURL(s,y).then(function(){return u(!0)}).catch(h),!y.seamless&&(f=r.player.config)!==null&&f!==void 0&&(g=f.hls)!==null&&g!==void 0&&g.keepStatusAfterSwitch&&r._keepPauseStatus()}else h()})}),c(D(r),"_keepPauseStatus",function(){var s=r.player.paused;s&&r.player.once("canplay",function(){r.player.pause()})}),r}return F(t,[{key:"core",get:function(){return this.hls}},{key:"version",get:function(){var e;return(e=this.hls)===null||e===void 0?void 0:e.version}},{key:"softDecode",get:function(){var e,i,n=(e=this.player)===null||e===void 0||(i=e.config)===null||i===void 0?void 0:i.mediaType;return!!n&&n!=="video"&&n!=="audio"}},{key:"beforePlayerInit",value:function(){var e=this,i=this.player.config,n=i.hls||{};if(!(!i.url&&!i.__allowHlsEmptyUrl__||!n.preferMMS&&K.isMMSOnly())){if(this.hls&&this.hls.destroy(),this.player.switchURL=this._onSwitchURL,this.player.handleSource=!1,n.innerDegrade=n.innerDegrade||i.innerDegrade,(n.disconnectTime===null||n.disconnectTime===void 0)&&(n.disconnectTime=0),this.hls=new se(O({softDecode:this.softDecode,isLive:i.isLive,media:this.player.media||this.player.video,startTime:i.startTime,url:i.url},n)),this.softDecode||we.defineGetterOrSetter(this.player,{url:{get:function(){var u,h;return(u=e.hls)===null||u===void 0||(h=u.media)===null||h===void 0?void 0:h.src},configurable:!0}}),this.softDecode&&(this.pluginExtension=new Ct(O({isLive:i.isLive,media:this.player.video},n),this),this.player.forceDegradeToVideo=function(){for(var o,u=arguments.length,h=new Array(u),d=0;d<u;d++)h[d]=arguments[d];return(o=e.pluginExtension)===null||o===void 0?void 0:o.forceDegradeToVideo.apply(o,h)}),i.isLive){var s;(s=this.player)===null||s===void 0||s.useHooks("replay",function(){var o;return(o=e.hls)===null||o===void 0?void 0:o.replay()})}this.on(ze,this._onSwitchSubtitle),this.on(qe,this._onSwitchURL),this.on(Je,this.destroy.bind(this)),this._transError(),this._transCoreEvent(I.TTFB),this._transCoreEvent(I.LOAD_START),this._transCoreEvent(I.LOAD_RESPONSE_HEADERS),this._transCoreEvent(I.LOAD_COMPLETE),this._transCoreEvent(I.LOAD_RETRY),this._transCoreEvent(I.SOURCEBUFFER_CREATED),this._transCoreEvent(I.MEDIASOURCE_OPENED),this._transCoreEvent(I.REMOVE_BUFFER),this._transCoreEvent(I.BUFFEREOS),this._transCoreEvent(I.KEYFRAME),this._transCoreEvent(I.METADATA_PARSED),this._transCoreEvent(I.DEMUXED_TRACK),this._transCoreEvent(I.SEI),this._transCoreEvent(I.SEI_IN_TIME),this._transCoreEvent(I.SPEED),this._transCoreEvent(I.HLS_MANIFEST_LOADED),this._transCoreEvent(I.HLS_LEVEL_LOADED),this._transCoreEvent(I.STREAM_EXCEPTION),this._transCoreEvent(I.SWITCH_URL_SUCCESS),this._transCoreEvent(I.SWITCH_URL_FAILED),this._transCoreEvent(P.NO_AUDIO_TRACK),this._transCoreEvent(P.STREAM_PARSED),this._transCoreEvent(P.SUBTITLE_SEGMENTS),this._transCoreEvent(P.SUBTITLE_PLAYLIST),this._transCoreEvent(P.APPEND_COST),i.url&&this.hls.load(i.url,!0).catch(function(o){})}}},{key:"destroy",value:function(){var e;this.hls&&(this.hls.destroy(),this.hls=null),(e=this.pluginExtension)===null||e===void 0||e.destroy(),this.pluginExtension=null}},{key:"_transError",value:function(){var e=this;this.hls.on(P.ERROR,function(i){e.player&&e.player.emit(Ze,new et(e.player,i))})}},{key:"_transCoreEvent",value:function(e){var i=this;this.hls.on(e,function(n){i.player&&(i.player.emit("core_event",O(O({},n),{},{eventName:e})),e===I.SEI_IN_TIME&&i.hls.hasSubtitle&&i._emitSeiPaylodTime(n))})}},{key:"_emitSeiPaylodTime",value:function(e){try{var i=JSON.parse(Array.from(e.data.payload).map(function(n){return String.fromCharCode(n)}).join("").slice(0,-1));if(!i.rtmp_dts)return;this.player.emit("core_event",{eventName:P.SEI_PAYLOAD_TIME,time:i.rtmp_dts})}catch{}}}],[{key:"pluginName",get:function(){return"hls"}},{key:"isSupported",value:function(e,i){return se.isSupported(e,i)}}]),t}(we);c(Fe,"Hls",se);c(Fe,"EVENT",P);export{Fe as H};
